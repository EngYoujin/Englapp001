<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DUOセレクト英単語クイズ (バグ修正版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', 'Inter', sans-serif; }
        .quiz-container { max-width: 800px; width: 95%; }
        .step-indicator.active { background-color: #3b82f6; color: white; font-weight: bold; }
        .btn-option:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .flashcard { perspective: 1000px; cursor: pointer; }
        .flashcard-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .flashcard.flipped .flashcard-inner { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 1rem; border-radius: 0.75rem; border: 1px solid #d1d5db; }
        .flashcard-front { background-color: white; }
        .flashcard-back { background-color: #f0f9ff; transform: rotateY(180deg); }
        .speaker-btn { position: absolute; top: 10px; right: 10px; color: #6b7280; }
        .speaker-btn:hover { color: #3b82f6; }
        .tooltip-trigger { border-bottom: 2px dotted #3b82f6; cursor: pointer; position: relative; }
        .tooltip-content { visibility: hidden; width: max-content; max-width: 250px; background-color: #1f2937; color: #fff; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 1; bottom: 125%; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .tooltip-trigger:hover .tooltip-content { visibility: visible; opacity: 1; }
        .toc-item.needs-review .review-mark { display: inline; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="quiz-container mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-8">
        <!-- Start Screen -->
        <div id="start-screen">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 text-center mb-4">DUOセレクト記憶定着クイズ</h1>
            <p class="text-gray-600 text-center mb-2">本での学習を「使える知識」に変えよう！</p>
            <p class="text-gray-500 text-center text-sm mb-8">新・4ステップ学習法で完璧マスター</p>
            <div class="text-center">
                <button id="start-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-full text-lg transition-transform transform hover:scale-105">
                    スタート (例文 1-10)
                </button>
            </div>
        </div>
        
        <!-- Table of Contents Screen -->
        <div id="toc-screen" class="hidden">
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">目次 (例文 1-10)</h2>
            <p class="text-sm text-gray-500 text-center mb-4">挑戦したい問題を選ぶか、苦手な問題から復習しましょう。</p>
            <div id="toc-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
             <div class="text-center mt-8">
                <button id="start-over-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-full">最初から全ての問題をやる</button>
            </div>
        </div>

        <!-- Main Quiz Area -->
        <div id="main-quiz-area" class="hidden">
            <!-- Progress and Title -->
            <div class="flex justify-between items-center mb-2">
                <h2 id="quiz-set-title" class="text-xl font-bold text-blue-600"></h2>
                <p id="question-counter" class="text-gray-500 font-medium"></p>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
                <div id="progress-bar" class="bg-blue-500 h-2.5 rounded-full" style="width: 0%; transition: width 0.3s ease-in-out;"></div>
            </div>
            <!-- Step Indicators -->
            <div class="flex justify-center space-x-1 md:space-x-2 mb-6 text-xs md:text-sm">
                <div id="step-indicator-1" class="step-indicator border border-gray-300 rounded-full px-3 py-1 text-gray-600 transition-all duration-300">1:クイズ</div>
                <div id="step-indicator-2" class="step-indicator border border-gray-300 rounded-full px-3 py-1 text-gray-600 transition-all duration-300">2:応用</div>
                <div id="step-indicator-3" class="step-indicator border border-gray-300 rounded-full px-3 py-1 text-gray-600 transition-all duration-300">3:復習</div>
                <div id="step-indicator-4" class="step-indicator border border-gray-300 rounded-full px-3 py-1 text-gray-600 transition-all duration-300 hidden">4:最終チェック</div>
            </div>

            <!-- Step Views -->
            <div id="step-views">
                <div id="step1-quiz" class="step-view"></div>
                <div id="step2-application" class="step-view hidden"></div>
                <div id="step3-flashcards" class="step-view hidden"></div>
                <div id="step4-final-check" class="step-view hidden"></div>
            </div>
            
            <!-- Navigation -->
            <div class="text-center mt-6">
                <button id="next-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-8 rounded-full transition-colors hidden">次へ</button>
            </div>
        </div>
        
        <!-- Result Screen -->
        <div id="result-screen" class="hidden text-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-4">お疲れ様でした！</h2>
            <p class="text-lg text-gray-700 mb-6">セクション1 (例文 1-10) を完了しました。</p>
            <div id="self-assessment-summary"></div>
            <div class="mt-8">
                <button id="review-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-full text-lg transition-transform transform hover:scale-105 mr-4">苦手な問題を復習する</button>
            </div>
        </div>
    </div>

<script>
// --- DATA ---
const quizData = [
    {
        id: 1,
        originalSentence: "Make a reservation at least a week in advance.",
        translation: "少なくとも一週間前には予約をしてください。",
        quiz: { target: "reservation", choices: ["reservation", "promise", "effort", "decision"], meaning: "予約" },
        application: {
            situation: "友達と超人気のテーマカフェに行くことに。サイトを見たら「予約必須」の文字が！",
            sentence: "I <span class='tooltip-trigger'>gotta<span class='tooltip-content'>gotta = got to<br>「～しなければならない」</span></span> make a reservation for that new cafe before it gets <span class='tooltip-trigger'>booked out<span class='tooltip-content'>booked out = 予約でいっぱい</span></span> by influencers.",
            translation: "インフルエンサーで予約が埋まる前に、あの新しいカフェを予約しなきゃ。"
        },
        flashcards: [
            { en: "at least", ja: "少なくとも", kana: "アット・**リー**スト", phonetic: "/ət liːst/", hint: "a" },
            { en: "in advance", ja: "前もって", kana: "イン・アド**ヴァ**ンス", phonetic: "/ɪn ədˈvæns/", hint: "i" }
        ]
    },
    {
        id: 2,
        originalSentence: "It doesn't make sense to turn down such a good offer.",
        translation: "そんなにいい話を断るなんておかしいよ。",
        quiz: { target: "make sense", choices: ["make sense", "make sure", "make use of", "make a promise"], meaning: "道理にかなう" },
        application: {
            situation: "友達が「時給3000円、シフト自由、まかない付きのバイトがあるけど断った」と言っている。",
            sentence: "Wait, you <span class='tooltip-trigger'>turned that down<span class='tooltip-content'>turn down = 断る</span></span>? That doesn't make any sense!",
            translation: "え、断ったの？全くもって意味がわからないよ！"
        },
        flashcards: [
            { en: "turn down", ja: "～を断る", kana: "**ター**ン・ダウン", phonetic: "/tɜːrn daʊn/", hint: "t" },
            { en: "offer", ja: "申し出、提案", kana: "**オ**ファー", phonetic: "/ˈɔːfər/", hint: "o" }
        ]
    },
    {
        id: 3,
        originalSentence: "I don't trust any candidate.",
        translation: "どの候補者も私は信用しない。",
        quiz: { target: "candidate", choices: ["candidate", "consumer", "scientist", "valley"], meaning: "候補者" },
        application: {
            situation: "クラス委員選挙。A君は「宿題をなくします！」、Bさんは「毎日お菓子を配ります！」と言っている。",
            sentence: "Honestly, I don't trust either candidate. Their promises are too <span class='tooltip-trigger'>unrealistic<span class='tooltip-content'>unrealistic = 非現実的な</span></span>.",
            translation: "正直、どっちの候補者も信用できないよ。公約が非現実的すぎる。"
        },
        flashcards: [
            { en: "trust", ja: "～を信用する", kana: "**トラ**スト", phonetic: "/trʌst/", hint: "t" },
            { en: "make a promise", ja: "約束をする", kana: "**メイ**ク・ア・**プロ**ミス", phonetic: "/meɪk ə ˈprɑːmɪs/", hint: "m" }
        ]
    },
    {
        id: 4,
        originalSentence: "He made a false statement during the trial.",
        translation: "彼は裁判で嘘の陳述をした。",
        quiz: { target: "statement", choices: ["statement", "structure", "effort", "reservation"], meaning: "陳述、声明" },
        application: {
            situation: "弟がお母さんのプリンを食べたのに、「僕じゃないよ、お兄ちゃんだよ！」と嘘をついている。",
            sentence: "My little brother made a false statement to Mom, <span class='tooltip-trigger'>blaming me for<span class='tooltip-content'>blame A for B = BのことでAを責める</span></span> eating her pudding!",
            translation: "弟がお母さんに嘘の供述をして、僕がプリンを食べたって罪をなすりつけたんだ！"
        },
        flashcards: [
            { en: "false", ja: "誤った、偽りの", kana: "**フォー**ルス", phonetic: "/fɔːls/", hint: "f" },
            { en: "trial", ja: "裁判", kana: "**トラ**イアル", phonetic: "/ˈtraɪəl/", hint: "t" }
        ]
    },
     {
        id: 5,
        originalSentence: "Make sure that your essay has a solid logical structure.",
        translation: "必ず、君の小論文がしっかりした論理的構造を持つようにしなさい。",
        quiz: { target: "structure", choices: ["structure", "trial", "experience", "intelligence"], meaning: "構造、構成" },
        application: {
            situation: "レポートの締め切り前夜。話があちこちに飛んでしまい、まとまらない…！",
            sentence: "My argument is <span class='tooltip-trigger'>all over the place<span class='tooltip-content'>all over the place = めちゃくちゃ、散らかっている</span></span>. I need to give it a more logical structure.",
            translation: "私の主張はめちゃくちゃだ。もっと論理的な構造を持たせないと。"
        },
        flashcards: [
            { en: "make sure", ja: "必ず～するようにする", kana: "**メイ**ク・**シュ**ア", phonetic: "/meɪk ʃʊr/", hint: "m" },
            { en: "solid", ja: "しっかりした", kana: "**ソ**リッド", phonetic: "/ˈsɑːlɪd/", hint: "s" },
            { en: "logical", ja: "論理的な", kana: "**ロ**ジカル", phonetic: "/ˈlɑːdʒɪkl/", hint: "l" }
        ]
    },
    {
        id: 6,
        originalSentence: "The more experience you have, the wiser decisions you will make.",
        translation: "経験を積めば積むほど、より賢明な決断ができるだろう。",
        quiz: { target: "experience", choices: ["experience", "effort", "promise", "sense"], meaning: "経験" },
        application: {
            situation: "初めてのバイトは失敗ばかり。でも、続けていくうちに「あ、これはこうすればいいんだ」とコツが掴めてきた。",
            sentence: "It's true what they say: the more experience you get, the better you become at <span class='tooltip-trigger'>handling things<span class='tooltip-content'>handle things = 物事を処理する、対処する</span></span>.",
            translation: "本当だよね、経験を積めば積むほど、物事の対処が上手くなるっていうのは。"
        },
        flashcards: [
            { en: "wise", ja: "賢明な", kana: "**ワ**イズ", phonetic: "/waɪz/", hint: "w" },
            { en: "make a decision", ja: "決断する", kana: "**メイ**ク・ア・ディ**シ**ジョン", phonetic: "/meɪk ə dɪˈsɪʒn/", hint: "m" }
        ]
    },
    {
        id: 7,
        originalSentence: "Some scientists are making use of artificial intelligence to predict earthquakes.",
        translation: "地震を予知するために人工知能を利用している科学者もいる。",
        quiz: { target: "predict", choices: ["predict", "deceive", "trust", "offer"], meaning: "～を予測する" },
        application: {
            situation: "明日の天気予報は晴れ。でも、最近のゲリラ豪雨を考えると、本当に当たるかな？",
            sentence: "It's so hard to predict the weather <span class='tooltip-trigger'>accurately<span class='tooltip-content'>accurately = 正確に</span></span> these days, even with all the technology.",
            translation: "最近はあらゆるテクノロジーを使っても、天気を正確に予測するのは本当に難しい。"
        },
        flashcards: [
            { en: "make use of", ja: "～を利用する", kana: "**メイ**ク・**ユー**ス・オブ", phonetic: "/meɪk juːs əv/", hint: "m" },
            { en: "artificial intelligence", ja: "人工知能", kana: "アーティ**フィ**シャル・イン**テ**リジェンス", phonetic: "/ˌɑːrtɪˈfɪʃl ɪnˈtelɪdʒəns/", hint: "a" }
        ]
    },
    {
        id: 8,
        originalSentence: "Unless you make every effort, you'll be left behind.",
        translation: "あらゆる努力をしなければ、取り残されるだろう。",
        quiz: { target: "effort", choices: ["effort", "offer", "trial", "sense"], meaning: "努力" },
        application: {
            situation: "テスト期間中、友達はみんな必死に勉強している。「まあ、大丈夫でしょ」と油断していると…",
            sentence: "I need to make a <span class='tooltip-trigger'>serious<span class='tooltip-content'>serious = 本気の、真剣な</span></span> effort to study, or I'm going to fail this exam.",
            translation: "本気で勉強に努力しないと、この試験に落ちちゃうよ。"
        },
        flashcards: [
            { en: "unless", ja: "～でない限り", kana: "アン**レ**ス", phonetic: "/ənˈles/", hint: "u" },
            { en: "be left behind", ja: "取り残される", kana: "ビー・**レ**フト・ビ**ハ**インド", phonetic: "/bi left bɪˈhaɪnd/", hint: "b" }
        ]
    },
    {
        id: 9,
        originalSentence: "The company has made deliberate attempts to deceive consumers.",
        translation: "その会社は消費者をだまそうと意図的な試みをした。",
        quiz: { target: "deceive", choices: ["deceive", "predict", "trust", "offer"], meaning: "～をだます" },
        application: {
            situation: "ネット広告で「飲むだけで痩せる！」というサプリを発見。でも、小さな文字で「※運動と食事制限が必要です」と…",
            sentence: "The ad was designed to deceive people into thinking it was a <span class='tooltip-trigger'>miracle cure<span class='tooltip-content'>miracle cure = 奇跡の治療薬</span></span>.",
            translation: "その広告は、奇跡の治療薬だと人々に思い込ませて騙すように作られていた。"
        },
        flashcards: [
            { en: "deliberate", ja: "意図的な", kana: "ディ**リ**ベレト", phonetic: "/dɪˈlɪbərət/", hint: "d" },
            { en: "attempt", ja: "試み", kana: "ア**テ**ンプト", phonetic: "/əˈtempt/", hint: "a" },
            { en: "consumer", ja: "消費者", kana: "コン**スュー**マー", phonetic: "/kənˈsuːmər/", hint: "c" }
        ]
    },
    {
        id: 10,
        originalSentence: "They made their way on foot through the valley.",
        translation: "彼らは徒歩で谷を通り抜けた。",
        quiz: { target: "on foot", choices: ["on foot", "in advance", "at least", "behind"], meaning: "徒歩で" },
        application: {
            situation: "夏フェス！最寄り駅から会場までバスが出てるけど長蛇の列…。「もう歩いちゃおうか！」",
            sentence: "The shuttle bus line was <span class='tooltip-trigger'>insane<span class='tooltip-content'>insane = ヤバい、正気じゃない</span></span>, so we decided to get to the festival site on foot.",
            translation: "シャトルバスの列がヤバかったから、フェス会場まで歩いていくことにしたんだ。"
        },
        flashcards: [
            { en: "make one's way", ja: "進む", kana: "**メイ**ク・ワンズ・**ウェ**イ", phonetic: "/meɪk wʌnz weɪ/", hint: "m" },
            { en: "valley", ja: "谷", kana: "**ヴァ**リー", phonetic: "/ˈvæli/", hint: "v" }
        ]
    }
];

// --- STATE ---
let currentSentenceIndex = 0;
let currentStep = 1;
let selfAssessments = new Array(quizData.length).fill(null);
let quizResults = new Array(quizData.length).fill(null);
let isFirstRun = true;
let speechSynthesis = window.speechSynthesis;
let englishVoice = null;
let quizQueue = [];

// --- DOM ELEMENTS ---
const startScreen = document.getElementById('start-screen');
const tocScreen = document.getElementById('toc-screen');
const mainQuizArea = document.getElementById('main-quiz-area');
const resultScreen = document.getElementById('result-screen');
const startBtn = document.getElementById('start-btn');
const nextBtn = document.getElementById('next-btn');
const reviewBtn = document.getElementById('review-btn');
const startOverBtn = document.getElementById('start-over-btn');

const stepViews = {
    1: document.getElementById('step1-quiz'),
    2: document.getElementById('step2-application'),
    3: document.getElementById('step3-flashcards'),
    4: document.getElementById('step4-final-check')
};
const stepIndicators = {
    1: document.getElementById('step-indicator-1'),
    2: document.getElementById('step-indicator-2'),
    3: document.getElementById('step-indicator-3'),
    4: document.getElementById('step-indicator-4')
};

// --- EVENT LISTENERS ---
startBtn.addEventListener('click', () => {
    isFirstRun = true;
    quizResults.fill(null);
    selfAssessments.fill(null);
    startQuizSession(Array.from(Array(quizData.length).keys()));
});
nextBtn.addEventListener('click', handleNext);
reviewBtn.addEventListener('click', showTableOfContents);
startOverBtn.addEventListener('click', () => {
    isFirstRun = false;
    startQuizSession(Array.from(Array(quizData.length).keys()));
});


// --- Voice Initialization Logic ---
function loadVoices() {
    const voices = speechSynthesis.getVoices();
    englishVoice = voices.find(voice => voice.lang.startsWith('en-US')) || voices.find(voice => voice.lang.startsWith('en-'));
}
speechSynthesis.onvoiceschanged = loadVoices;
loadVoices();

// --- FUNCTIONS ---

function speak(text, lang = 'en-US') {
    if (speechSynthesis.speaking) speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    if (englishVoice) utterance.voice = englishVoice;
    utterance.lang = lang;
    utterance.rate = 0.9;
    speechSynthesis.speak(utterance);
}

function startQuizSession(indices) {
    quizQueue = indices;
    if (quizQueue.length === 0) {
        showTableOfContents();
        return;
    }
    currentSentenceIndex = quizQueue.shift();
    currentStep = 1;
    startScreen.classList.add('hidden');
    tocScreen.classList.add('hidden');
    resultScreen.classList.add('hidden');
    mainQuizArea.classList.remove('hidden');
    nextBtn.classList.add('hidden');
    renderCurrentStep();
}

function handleNext() {
    if (currentStep === 4) {
        showResult();
        return;
    }

    currentStep++;

    if (currentStep > 3) {
        if (quizQueue.length > 0) {
            currentSentenceIndex = quizQueue.shift();
            currentStep = 1;
            renderCurrentStep();
        } else {
            if (isFirstRun) {
                currentStep = 4;
                renderCurrentStep();
            } else {
                showTableOfContents();
            }
        }
    } else {
        renderCurrentStep();
    }
}


function updateProgress() {
    document.getElementById('question-counter').textContent = `例文 ${currentSentenceIndex + 1}`;
    const progress = isFirstRun ? ((quizData.length - quizQueue.length - 1) / quizData.length) * 100 : 0;
    document.getElementById('progress-bar').style.width = `${progress}%`;

    Object.values(stepIndicators).forEach(el => el.classList.remove('active'));
    stepIndicators[4].classList.toggle('hidden', isFirstRun === false);
    if (stepIndicators[currentStep]) {
        stepIndicators[currentStep].classList.add('active');
    }
}

function renderCurrentStep() {
    updateProgress();
    Object.values(stepViews).forEach(view => view.classList.add('hidden'));
    stepViews[currentStep].classList.remove('hidden');
    nextBtn.classList.add('hidden');

    if (currentStep === 4) {
        renderStep4();
        return;
    }

    const data = quizData[currentSentenceIndex];
    switch (currentStep) {
        case 1: renderStep1(data); break;
        case 2: renderStep2(data); break;
        case 3: renderStep3(data); break;
    }
}

// --- RENDER FUNCTIONS FOR EACH STEP ---

function renderStep1(data) {
    const { quiz, originalSentence } = data;
    const questionText = originalSentence.replace(quiz.target, '______');
    const shuffledChoices = [...quiz.choices].sort(() => Math.random() - 0.5);
    
    let optionsHTML = shuffledChoices.map(choice => 
        `<button class="btn-option w-full p-4 bg-white border border-gray-300 rounded-lg text-left text-gray-700 font-medium transition-all duration-200">${choice}</button>`
    ).join('');

    stepViews[1].innerHTML = `
        <p class="text-sm text-gray-500 text-center mb-4">あてはまる選択肢を選びましょう。</p>
        <div class="mb-6 relative">
            <p class="text-xl md:text-2xl text-gray-800 text-center p-4 bg-gray-50 rounded-lg">${questionText}</p>
            <button class="speaker-btn text-xl" onclick="speak('${originalSentence.replace(/'/g, "\\'")}')"><i class="fas fa-volume-up"></i></button>
        </div>
        <div id="step1-options" class="grid grid-cols-1 md:grid-cols-2 gap-4">${optionsHTML}</div>
        <div id="step1-feedback" class="p-4 rounded-lg text-center font-medium hidden my-4"></div>
    `;

    document.getElementById('step1-options').addEventListener('click', e => {
        if (e.target.tagName === 'BUTTON') {
            handleQuizAnswer(e.target, quiz, data.translation);
        }
    });
}

function handleQuizAnswer(selectedButton, quizInfo, translation) {
    const isCorrect = selectedButton.innerText === quizInfo.target;
    // BUG FIX: Always update the quizResults, not just on the first run.
    quizResults[currentSentenceIndex] = isCorrect;
    
    const feedbackEl = document.getElementById('step1-feedback');
    
    if (isCorrect) {
        feedbackEl.innerHTML = `正解！ <span class="font-bold">${quizInfo.target}</span> は「${quizInfo.meaning}」という意味です。`;
        feedbackEl.className = 'p-4 rounded-lg text-center font-medium my-4 bg-green-100 border border-green-300 text-green-800';
    } else {
        feedbackEl.innerHTML = `不正解。正解は <span class="font-bold">${quizInfo.target}</span> です。<br>「${quizInfo.meaning}」という意味になります。`;
        feedbackEl.className = 'p-4 rounded-lg text-center font-medium my-4 bg-red-100 border border-red-300 text-red-800';
    }
    feedbackEl.classList.remove('hidden');
    
    const translationEl = document.createElement('p');
    translationEl.className = 'text-center text-gray-600 mt-2';
    translationEl.textContent = `文全体の訳：${translation}`;
    feedbackEl.appendChild(translationEl);

    Array.from(document.getElementById('step1-options').children).forEach(button => {
        button.disabled = true;
        if (button.innerText === quizInfo.target) button.classList.add('bg-green-200', 'border-green-500');
        else if (button === selectedButton) button.classList.add('bg-red-200', 'border-red-500');
    });

    nextBtn.textContent = '応用例文へ →';
    nextBtn.classList.remove('hidden');
}

function renderStep2(data) {
    const { application } = data;
    stepViews[2].innerHTML = `
        <p class="text-sm text-gray-500 text-center mb-4">応用例文で使い方を確認しましょう。</p>
        <div class="bg-sky-50 border-l-4 border-sky-500 p-4 rounded-lg mb-4">
            <p class="font-semibold text-sky-800 mb-2">💡 こんな場面で使える！</p>
            <p class="text-gray-700">${application.situation}</p>
        </div>
        <div class="mb-4 relative p-4 bg-gray-50 rounded-lg">
            <p class="text-lg md:text-xl text-gray-800">${application.sentence}</p>
            <button class="speaker-btn text-xl" onclick="speak(this.previousElementSibling.innerText.replace(/'/g, &quot;\\'&quot;))"><i class="fas fa-volume-up"></i></button>
        </div>
        <div class="text-center mb-6">
            <button id="show-translation-btn" class="text-blue-600 hover:underline">日本語訳を見る</button>
        </div>
        <p id="translation-text" class="text-center text-gray-600 hidden mb-6">${application.translation}</p>
        <div id="self-assessment-buttons" class="flex justify-center space-x-4">
            <button data-cleared="false" class="self-assess-btn border border-gray-400 text-gray-700 font-bold py-2 px-6 rounded-full hover:bg-gray-100">もう一度</button>
            <button data-cleared="true" class="self-assess-btn bg-green-500 text-white font-bold py-2 px-6 rounded-full hover:bg-green-600">理解できた！</button>
        </div>
    `;

    document.getElementById('show-translation-btn').addEventListener('click', e => {
        document.getElementById('translation-text').classList.toggle('hidden');
        e.target.textContent = document.getElementById('translation-text').classList.contains('hidden') ? '日本語訳を見る' : '日本語訳を隠す';
    });

    document.getElementById('self-assessment-buttons').addEventListener('click', e => {
        if (e.target.classList.contains('self-assess-btn')) {
            const cleared = e.target.dataset.cleared === 'true';
            // BUG FIX: Always update the selfAssessments array.
            selfAssessments[currentSentenceIndex] = cleared;
            
            // BUG FIX: During review, if user marks as "cleared", also mark the quiz part as cleared for the TOC.
            // BUT ONLY if the quiz was already correct. Don't overwrite a wrong answer.
            if (!isFirstRun && cleared) {
                // This logic is now handled by the quiz result itself. This part is simplified.
                // If the user gets the quiz right in review, the mark will be removed.
            }

            nextBtn.textContent = '単語の復習へ →';
            nextBtn.classList.remove('hidden');
            document.querySelectorAll('.self-assess-btn').forEach(btn => {
                btn.disabled = true;
                btn.classList.add('opacity-50');
            });
            e.target.classList.remove('opacity-50');
        }
    });
}

function renderFlashcards(container, cards, defaultMode) {
    container.innerHTML = '';
    cards.forEach(card => {
        const cardEl = document.createElement('div');
        cardEl.className = 'flashcard h-48';
        
        const frontContent = (defaultMode === 'en-ja') 
            ? `<h3 class="text-2xl font-bold">${card.en}</h3>`
            : `<h3 class="text-xl font-bold">${card.ja}</h3><p class="text-gray-500 mt-2">ヒント: ${card.hint}</p>`;
        
        const backContent = (defaultMode === 'en-ja')
            ? `<h3 class="text-xl font-bold">${card.ja}</h3>`
            : `<h3 class="text-2xl font-bold">${card.en}</h3>`;

        cardEl.innerHTML = `
            <div class="flashcard-inner">
                <div class="flashcard-front">${frontContent}<button class="speaker-btn" onclick="event.stopPropagation(); speak('${card.en.replace(/'/g, "\\'")}')"><i class="fas fa-volume-up"></i></button></div>
                <div class="flashcard-back">
                    ${backContent}
                    <div class="text-center mt-2">
                        <p class="text-gray-500">${card.kana.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')}</p>
                        <p class="text-gray-400 text-sm">${card.phonetic}</p>
                    </div>
                    <button class="speaker-btn" onclick="event.stopPropagation(); speak('${card.en.replace(/'/g, "\\'")}')"><i class="fas fa-volume-up"></i></button>
                </div>
            </div>
        `;
        cardEl.addEventListener('click', () => cardEl.classList.toggle('flipped'));
        container.appendChild(cardEl);
    });
}

function renderStep3(data) {
    const { flashcards } = data;
    stepViews[3].innerHTML = `
        <p class="text-sm text-gray-500 text-center mb-4">カードをタップして関連単語も覚えましょう。</p>
        <div class="flex justify-center mb-4">
            <div class="inline-flex rounded-md shadow-sm" role="group">
                <button type="button" id="mode-en-ja-step3" class="mode-btn bg-blue-500 text-white px-4 py-2 text-sm font-medium border border-gray-200 rounded-l-lg">認識 (英→日)</button>
                <button type="button" id="mode-ja-en-step3" class="mode-btn bg-white text-gray-900 px-4 py-2 text-sm font-medium border border-gray-200 rounded-r-lg hover:bg-gray-100">想起 (日→英)</button>
            </div>
        </div>
        <div id="flashcard-container-step3" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    `;

    const container = document.getElementById('flashcard-container-step3');
    renderFlashcards(container, flashcards, 'en-ja');

    const modeBtnEnJa = document.getElementById('mode-en-ja-step3');
    const modeBtnJaEn = document.getElementById('mode-ja-en-step3');
    
    modeBtnEnJa.addEventListener('click', () => {
        modeBtnEnJa.classList.add('bg-blue-500', 'text-white');
        modeBtnJaEn.classList.remove('bg-blue-500', 'text-white');
        renderFlashcards(container, flashcards, 'en-ja');
    });
    
    modeBtnJaEn.addEventListener('click', () => {
        modeBtnJaEn.classList.add('bg-blue-500', 'text-white');
        modeBtnEnJa.classList.remove('bg-blue-500', 'text-white');
        renderFlashcards(container, flashcards, 'ja-en');
    });

    const nextText = isFirstRun ? 
        (quizQueue.length === 0 ? '最終チェックへ →' : '次の問題へ →') :
        (quizQueue.length === 0 ? '目次に戻る' : '次の問題へ →');
    nextBtn.textContent = nextText;
    nextBtn.classList.remove('hidden');
}

function renderStep4() {
    let allFlashcards = quizData.flatMap(d => d.flashcards).sort(() => Math.random() - 0.5);

    stepViews[4].innerHTML = `
        <p class="text-sm text-gray-500 text-center mb-4">セクションの総復習！日本語から英語を思い出してみましょう。</p>
        <div class="flex justify-center mb-4">
            <div class="inline-flex rounded-md shadow-sm" role="group">
                <button type="button" id="mode-en-ja-step4" class="mode-btn bg-white text-gray-900 px-4 py-2 text-sm font-medium border border-gray-200 rounded-l-lg hover:bg-gray-100">認識 (英→日)</button>
                <button type="button" id="mode-ja-en-step4" class="mode-btn bg-blue-500 text-white px-4 py-2 text-sm font-medium border border-gray-200 rounded-r-lg">想起 (日→英)</button>
            </div>
        </div>
        <div id="flashcard-container-step4" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    `;

    const container = document.getElementById('flashcard-container-step4');
    renderFlashcards(container, allFlashcards, 'ja-en');

    const modeBtnEnJa = document.getElementById('mode-en-ja-step4');
    const modeBtnJaEn = document.getElementById('mode-ja-en-step4');

    modeBtnEnJa.addEventListener('click', () => {
        modeBtnEnJa.classList.add('bg-blue-500', 'text-white');
        modeBtnJaEn.classList.remove('bg-blue-500', 'text-white');
        renderFlashcards(container, allFlashcards, 'en-ja');
    });
    
    modeBtnJaEn.addEventListener('click', () => {
        modeBtnJaEn.classList.add('bg-blue-500', 'text-white');
        modeBtnEnJa.classList.remove('bg-blue-500', 'text-white');
        renderFlashcards(container, allFlashcards, 'ja-en');
    });

    nextBtn.textContent = '結果を見る';
    nextBtn.classList.remove('hidden');
}

function showResult() {
    mainQuizArea.classList.add('hidden');
    resultScreen.classList.remove('hidden');
    
    const clearedCount = selfAssessments.filter(sa => sa === true).length;
    const totalAssessed = selfAssessments.filter(sa => sa !== null).length;
    
    const summaryEl = document.getElementById('self-assessment-summary');
    summaryEl.innerHTML = `
        <p class="text-xl">応用例文の理解度: <span class="font-bold text-green-600">${clearedCount}</span> / ${totalAssessed}</p>
        <p class="text-gray-600 mt-2">「もう一度」を選んだ問題やクイズで間違えた問題は、復習リストに追加されています。</p>
    `;
    isFirstRun = false;
}

function showTableOfContents() {
    resultScreen.classList.add('hidden');
    mainQuizArea.classList.add('hidden');
    startScreen.classList.add('hidden');
    tocScreen.classList.remove('hidden');
    const tocList = document.getElementById('toc-list');
    tocList.innerHTML = '';
    quizData.forEach((data, index) => {
        const needsReview = quizResults[index] === false || selfAssessments[index] === false;
        const item = document.createElement('button');
        item.className = 'toc-item p-4 border rounded-lg text-center hover:bg-gray-100 transition-colors';
        if (needsReview) item.classList.add('needs-review', 'border-red-400', 'bg-red-50');
        
        item.innerHTML = `
            例文 ${index + 1}
            <span class="review-mark text-red-500 ${needsReview ? '' : 'hidden'}">🔴</span>
        `;
        item.onclick = () => {
            isFirstRun = false;
            startQuizSession([index]);
        };
        tocList.appendChild(item);
    });
}
</script>
</body>
</html>
