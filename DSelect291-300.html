<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>単語帳学習アプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', 'Inter', sans-serif; }
        .quiz-container { max-width: 800px; width: 95%; }
        .step-indicator.active { background-color: #3b82f6; color: white; font-weight: bold; }
        .btn-option:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .flashcard { perspective: 1000px; cursor: pointer; }
        .flashcard-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .flashcard.flipped .flashcard-inner { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 1rem; border-radius: 0.75rem; border: 1px solid #d1d5db; }
        .flashcard-front { background-color: white; }
        .flashcard-back { background-color: #f0f9ff; transform: rotateY(180deg); }
        .speaker-btn { position: absolute; top: 10px; right: 10px; color: #6b7280; }
        .speaker-btn:hover { color: #3b82f6; }
        .tooltip-trigger { border-bottom: 2px dotted #3b82f6; cursor: pointer; position: relative; }
        .tooltip-content { visibility: hidden; width: max-content; max-width: 250px; background-color: #1f2937; color: #fff; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 1; bottom: 125%; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .tooltip-trigger:hover .tooltip-content { visibility: visible; opacity: 1; }
        .review-mark {
            display: inline-block;
            font-size: 0.7rem;
            font-weight: bold;
            color: white;
            background-color: #ef4444;
            border-radius: 9999px;
            width: 1.1rem;
            height: 1.1rem;
            line-height: 1.1rem;
            text-align: center;
            margin-left: 0.25rem;
        }
        .toc-item-content {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .segment { display: inline-flex; border: 1px solid #d1d5db; border-radius: 9999px; overflow: hidden; }
        .segment button { border: 0; background-color: white; padding: 0.5rem 0.75rem; font-size: 0.875rem; cursor: pointer; min-height: 36px; transition: background-color 0.2s, color 0.2s; }
        .segment button.on { background-color: #1f2937; color: white; }
    </style>
</head>
<body class="bg-gray-100 pt-20 pb-8 min-h-screen">

    <header class="bg-white border-b fixed top-0 left-0 right-0 z-50 shadow-sm">
        <div class="quiz-container mx-auto p-3 flex justify-between items-center">
            <h1 class="text-lg font-bold text-gray-800">Deselect 高機能版</h1>
            <div class="flex items-center gap-4 text-sm">
                <a href="#" id="header-toc-link" class="text-gray-600 hover:text-blue-500">目次</a>
                <a href="#" id="header-review-link" class="text-gray-600 hover:text-blue-500 relative">
                    今日の復習
                    <span id="header-review-badge" class="absolute -top-2 -right-3 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden"></span>
                </a>
                <button id="reset-data-btn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-1 px-3 border border-gray-300 rounded-full">
                    リセット
                </button>
            </div>
        </div>
    </header>

    <div id="app-container" class="quiz-container mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-8">
        
        <!-- 目次画面 (メインメニュー) -->
        <div id="toc-screen">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 text-center mb-4">DUOセレクト学習</h1>
            <p class="text-gray-600 text-center mb-8">学習したい例文を選ぶか、最初から全ての問題に挑戦しましょう。</p>
            
            <div id="review-banner-container" class="mb-8"></div>

            <div class="flex justify-center items-center gap-x-6 gap-y-4 flex-wrap mb-8 text-sm text-gray-600 border bg-gray-50 p-4 rounded-lg">
                <span class="flex items-center">
                    <i class="fas fa-sliders-h mr-2 text-gray-500"></i><strong>音声・表示設定</strong>
                </span>
                <span>速度: <input id="rate" type="range" min="0.6" max="1.4" step="0.1" value="1" class="align-middle w-24"></span>
                <span class="flex items-center">声:
                    <span class="segment ml-2" id="voiceSeg">
                        <button data-v="auto" class="on">自動</button>
                        <button data-v="male">男</button>
                        <button data-v="female">女</button>
                    </span>
                </span>
                <span class="flex items-center">単語カード:
                    <span class="segment ml-2" id="cardModeSeg">
                        <button data-v="en-ja" class="on">認識 (英→日)</button>
                        <button data-v="ja-en">想起 (日→英)</button>
                    </span>
                </span>
                <span class="flex items-center">想起ヒント:
                    <span class="segment ml-2" id="hintModeSeg">
                        <button data-v="on" class="on">ON</button>
                        <button data-v="off">OFF</button>
                    </span>
                </span>
            </div>

            <div class="border-b pb-8 mb-8">
                <h2 class="text-lg font-bold text-gray-700 text-center mb-4">メイン学習</h2>
                <button id="start-sequential-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-full text-lg transition-transform transform hover:scale-105">
                    最初から順番に全ての問題をやる
                </button>
            </div>

            <div>
                <h2 class="text-lg font-bold text-gray-700 text-center mb-4">個別学習・復習</h2>
                <div id="toc-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
            </div>
            
            <div class="border-t pt-8 mt-8">
                 <h2 class="text-lg font-bold text-gray-700 text-center mb-4">腕試し</h2>
                 <button id="final-check-btn" class="w-full bg-white hover:bg-gray-100 text-gray-700 font-semibold py-2 px-6 border border-gray-300 rounded-full">
                    まとめて最終チェック
                </button>
            </div>
        </div>

        <!-- 復習エリア -->
        <div id="review-area" class="hidden">
             <!-- renderReview() によって内容が生成されます -->
        </div>

        <!-- メインクイズエリア -->
        <div id="main-quiz-area" class="hidden">
            <!-- 進捗とタイトル -->
            <div class="flex justify-between items-center mb-2">
                 <button id="back-to-toc-btn" class="text-blue-500 hover:text-blue-700 font-semibold"><i class="fas fa-arrow-left mr-2"></i>目次に戻る</button>
                <p id="question-counter" class="text-gray-500 font-medium"></p>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
                <div id="progress-bar" class="bg-blue-500 h-2.5 rounded-full" style="width: 0%; transition: width 0.3s ease-in-out;"></div>
            </div>
            <!-- ステップインジケーター -->
            <div class="flex justify-center space-x-1 md:space-x-2 mb-6 text-xs md:text-sm" id="step-indicators-container">
                <button data-step="1" class="step-indicator border border-gray-300 rounded-full px-3 py-1 text-gray-600 transition-all duration-300">1:クイズ</button>
                <button data-step="2" class="step-indicator border border-gray-300 rounded-full px-3 py-1 text-gray-600 transition-all duration-300">2:応用</button>
                <button data-step="3" class="step-indicator border border-gray-300 rounded-full px-3 py-1 text-gray-600 transition-all duration-300">3:単語カード</button>
            </div>

            <!-- ステップビュー -->
            <div id="step-views">
                <div id="step1-quiz" class="step-view"></div>
                <div id="step2-application" class="step-view hidden"></div>
                <div id="step3-flashcards" class="step-view hidden"></div>
            </div>
            
            <!-- ナビゲーション -->
            <div class="text-center mt-6">
                <button id="next-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-8 rounded-full transition-colors hidden">次へ</button>
            </div>

            <!-- 例文ナビゲーション -->
            <div id="sentence-nav" class="flex justify-between mt-4 pt-4 border-t">
                <button id="prev-sentence-btn" class="text-blue-500 hover:text-blue-700 font-semibold disabled:opacity-50 disabled:cursor-not-allowed"><i class="fas fa-chevron-left mr-2"></i>前の例文</button>
                <button id="next-sentence-btn" class="text-blue-500 hover:text-blue-700 font-semibold disabled:opacity-50 disabled:cursor-not-allowed">次の例文<i class="fas fa-chevron-right ml-2"></i></button>
            </div>
        </div>
        
        <!-- 最終チェックエリア -->
        <div id="final-check-area" class="hidden">
            <div class="flex justify-between items-center mb-4">
                 <button id="back-to-toc-from-final-btn" class="text-blue-500 hover:text-blue-700 font-semibold"><i class="fas fa-arrow-left mr-2"></i>目次に戻る</button>
                 <button id="shuffle-final-check-btn" class="text-blue-500 hover:text-blue-700 font-semibold"><i class="fas fa-random mr-2"></i>順番をシャッフル</button>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-4">まとめて最終チェック</h2>
            <p id="final-check-description" class="text-sm text-gray-500 text-center mb-6">日本語を見て、対応する英単語を思い出してみましょう。カードをタップすると答えが表示されます。</p>
            <div id="final-check-flashcards" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>

        <!-- 結果画面 -->
        <div id="result-screen" class="hidden text-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-4">全問終了！お疲れ様でした！</h2>
            <p class="text-lg text-gray-700 mb-6">学習結果を確認しましょう。</p>
            <div id="self-assessment-summary"></div>
            <div class="mt-8">
                <button id="review-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-full text-lg transition-transform transform hover:scale-105 mr-4">目次で復習する</button>
            </div>
        </div>
    </div>

<script>
// --- 学習アプリのロジック ---
const quizData = [
    {
        id: 291,
        originalSentence: "The editor looked through the manuscript, but he didn't think it was worth publishing.",
        translation: "編集者はその原稿にざっと目を通したが、出版する価値があるとは思わなかった。",
        quiz: {
            originalSentence: "This old book may not be ______ much money, but it has sentimental value.",
            target: "worth",
            choices: ["worth", "cost", "price", "charge"],
            meaning: "～の価値がある",
            quizTranslation: "この古い本は金銭的な価値はあまりないかもしれないが、愛着がある。"
        },
        application: {
            situation: "作家が編集者に自分の原稿を見せ、意見を求めている場面。",
            sentence: "The <span class='tooltip-trigger'>editor<span class='tooltip-content'>編集者</span></span> promised to <span class='tooltip-trigger'>look through<span class='tooltip-content'>～にざっと目を通す</span></span> my <span class='tooltip-trigger'>manuscript<span class='tooltip-content'>原稿</span></span> and tell me if it's <span class='tooltip-trigger'>worth<span class='tooltip-content'>～の価値がある</span></span> <span class='tooltip-trigger'>publishing<span class='tooltip-content'>出版すること</span></span>.",
            translation: "編集者は私の原稿に目を通して、出版する価値があるかどうか教えてくれると約束した。"
        },
        flashcards: [
            { en: "editor", ja: "編集者", kana: "**エ**ディター", phonetic: "/ˈedɪtər/", hint: "e" },
            { en: "look through", ja: "～にざっと目を通す", kana: "ルック・ス**ルー**", phonetic: "/lʊk θruː/", hint: "l" },
            { en: "manuscript", ja: "原稿", kana: "**マ**ニュスクリプト", phonetic: "/ˈmænjuskrɪpt/", hint: "m" },
            { en: "be worth", ja: "～の価値がある", kana: "ビー・**ワー**ス", phonetic: "/bi wɜːrθ/", hint: "b" },
            { en: "publish", ja: "～を出版する", kana: "**パ**ブリッシュ", phonetic: "/ˈpʌblɪʃ/", hint: "p" }
        ]
    },
    {
        id: 292,
        originalSentence: "He quoted the passage without permission from the author.",
        translation: "彼は著者の許可なしにその一節を引用した。",
        quiz: {
            originalSentence: "You must get ______ from your parents to go on the trip.",
            target: "permission",
            choices: ["permission", "rejection", "opinion", "information"],
            meaning: "許可",
            quizTranslation: "その旅行に行くには、両親から許可を得なければならない。"
        },
        application: {
            situation: "レポートや論文で他の人の文章を引用するときのルールについて。",
            sentence: "When you <span class='tooltip-trigger'>quote<span class='tooltip-content'>～を引用する</span></span> a <span class='tooltip-trigger'>passage<span class='tooltip-content'>一節</span></span> from another <span class='tooltip-trigger'>author<span class='tooltip-content'>著者</span></span>, you must always get <span class='tooltip-trigger'>permission<span class='tooltip-content'>許可</span></span> or cite the source properly.",
            translation: "他の著者の文章の一節を引用する際は、必ず許可を得るか、出典を適切に記載しなければなりません。"
        },
        flashcards: [
            { en: "quote", ja: "～を引用する", kana: "クォウト", phonetic: "/kwoʊt/", hint: "q" },
            { en: "passage", ja: "（文章の）一節", kana: "**パ**ッセージ", phonetic: "/ˈpæsɪdʒ/", hint: "p" },
            { en: "permission", ja: "許可", kana: "パー**ミ**ッション", phonetic: "/pərˈmɪʃn/", hint: "p" },
            { en: "author", ja: "著者", kana: "**オー**サー", phonetic: "/ˈɔːθər/", hint: "a" }
        ]
    },
    {
        id: 293,
        originalSentence: "They overlooked essential elements of his philosophy.",
        translation: "彼らは彼の哲学の本質的な要素を見落とした。",
        quiz: {
            originalSentence: "In his haste, he ______ an important detail in the report.",
            target: "overlooked",
            choices: ["overlooked", "understood", "explained", "discovered"],
            meaning: "～を見落とした",
            quizTranslation: "彼は急いでいたので、報告書の重要な詳細を見落としてしまった。"
        },
        application: {
            situation: "プロジェクトの計画を見直している時に、重要な点が見過ごされていたことに気づく。",
            sentence: "I think we've <span class='tooltip-trigger'>overlooked<span class='tooltip-content'>～を見落とす</span></span> an <span class='tooltip-trigger'>essential<span class='tooltip-content'>本質的な</span></span> <span class='tooltip-trigger'>element<span class='tooltip-content'>要素</span></span> of the user's needs in our initial plan.",
            translation: "初期計画では、ユーザーのニーズの本質的な要素を見落としていたと思う。"
        },
        flashcards: [
            { en: "overlook", ja: "～を見落とす", kana: "オーバー**ル**ック", phonetic: "/ˌoʊvərˈlʊk/", hint: "o" },
            { en: "essential", ja: "本質的な", kana: "エッ**セ**ンシャル", phonetic: "/ɪˈsenʃl/", hint: "e" },
            { en: "element", ja: "要素", kana: "**エ**レメント", phonetic: "/ˈelɪmənt/", hint: "e" },
            { en: "philosophy", ja: "哲学", kana: "フィ**ロ**ソフィ", phonetic: "/fɪˈlɑːsəfi/", hint: "p" }
        ]
    },
    {
        id: 294,
        originalSentence: "Kawabata received the Nobel Prize for literature.",
        translation: "川端氏はノーベル文学賞を受賞した。",
        quiz: {
            originalSentence: "She won first ______ in the speech contest.",
            target: "prize",
            choices: ["prize", "price", "cost", "bill"],
            meaning: "賞",
            quizTranslation: "彼女はスピーチコンテストで一等賞を獲得した。"
        },
        application: {
            situation: "ある科学者が画期的な発見で有名な賞を受賞したニュースについて話す。",
            sentence: "Dr. Evans is expected to <span class='tooltip-trigger'>receive<span class='tooltip-content'>～を受け取る</span></span> a prestigious <span class='tooltip-trigger'>prize<span class='tooltip-content'>賞</span></span> for her work in genetics, which is a great honor in her field.",
            translation: "エバンス博士は遺伝学における業績で名誉ある賞を受賞すると期待されており、それは彼女の分野で大変な名誉なことだ。"
        },
        flashcards: [
            { en: "receive", ja: "～を受け取る", kana: "リ**シー**ヴ", phonetic: "/rɪˈsiːv/", hint: "r" },
            { en: "prize", ja: "賞", kana: "プライズ", phonetic: "/praɪz/", hint: "p" },
            { en: "literature", ja: "文学", kana: "**リ**テラチャー", phonetic: "/ˈlɪtərətʃər/", hint: "l" }
        ]
    },
    {
        id: 295,
        originalSentence: "Try to conserve scarce resources instead of wasting them.",
        translation: "乏しい資源を無駄遣いする代わりに、大切に使うようにしなさい。",
        quiz: {
            originalSentence: "We should all try to ______ water and electricity.",
            target: "conserve",
            choices: ["conserve", "waste", "produce", "increase"],
            meaning: "～を大切に使う",
            quizTranslation: "私たちは皆、水と電気を大切に使うよう努めるべきだ。"
        },
        application: {
            situation: "環境保護の重要性について議論している時。",
            sentence: "It's important to <span class='tooltip-trigger'>conserve<span class='tooltip-content'>～を大切に使う</span></span> <span class='tooltip-trigger'>scarce<span class='tooltip-content'>乏しい</span></span> natural <span class='tooltip-trigger'>resources<span class='tooltip-content'>資源</span></span> <span class='tooltip-trigger'>instead of<span class='tooltip-content'>～の代わりに</span></span> <span class='tooltip-trigger'>wasting<span class='tooltip-content'>～を無駄にする</span></span> them.",
            translation: "乏しい天然資源を無駄にする代わりに大切に使うことが重要だ。"
        },
        flashcards: [
            { en: "conserve", ja: "～を大切に使う", kana: "コン**サー**ヴ", phonetic: "/kənˈsɜːrv/", hint: "c" },
            { en: "scarce", ja: "乏しい", kana: "スケアス", phonetic: "/skers/", hint: "s" },
            { en: "resource", ja: "資源", kana: "リ**ソー**ス", phonetic: "/ˈriːsɔːrs/", hint: "r" },
            { en: "instead of", ja: "～の代わりに", kana: "インス**テ**ッド・オブ", phonetic: "/ɪnˈsted əv/", hint: "i" },
            { en: "waste", ja: "～を無駄に使う", kana: "ウェイスト", phonetic: "/weɪst/", hint: "w" }
        ]
    },
    {
        id: 296,
        originalSentence: "He emphasized how urgent it was to find alternative sources of energy.",
        translation: "彼は代替エネルギー源を見つけることがいかに急務であるかを強調した。",
        quiz: {
            originalSentence: "The doctor ______ the importance of a healthy diet.",
            target: "emphasized",
            choices: ["emphasized", "ignored", "questioned", "denied"],
            meaning: "～を強調した",
            quizTranslation: "医者は健康的な食事の重要性を強調した。"
        },
        application: {
            situation: "地球温暖化対策についての会議で。",
            sentence: "The speaker <span class='tooltip-trigger'>emphasized<span class='tooltip-content'>～を強調する</span></span> the <span class='tooltip-trigger'>urgent<span class='tooltip-content'>緊急の</span></span> need for <span class='tooltip-trigger'>alternative<span class='tooltip-content'>代わりの</span></span> <span class='tooltip-trigger'>sources<span class='tooltip-content'>源</span></span> of <span class='tooltip-trigger'>energy<span class='tooltip-content'>エネルギー</span></span>.",
            translation: "講演者は、代替エネルギー源の緊急の必要性を強調した。"
        },
        flashcards: [
            { en: "emphasize", ja: "～を強調する", kana: "**エ**ンファサイズ", phonetic: "/ˈemfəsaɪz/", hint: "e" },
            { en: "urgent", ja: "緊急の", kana: "**アー**ジェント", phonetic: "/ˈɜːrdʒənt/", hint: "u" },
            { en: "alternative", ja: "代わりの", kana: "オル**ター**ナティヴ", phonetic: "/ɔːlˈtɜːrnətɪv/", hint: "a" },
            { en: "source", ja: "源", kana: "ソース", phonetic: "/sɔːrs/", hint: "s" },
            { en: "energy", ja: "エネルギー", kana: "**エ**ナジー", phonetic: "/ˈenərdʒi/", hint: "e" }
        ]
    },
    {
        id: 297,
        originalSentence: "The desert is not suitable for farming because its soil is not rich.",
        translation: "その砂漠は土壌が肥沃でないため、農業には適していない。",
        quiz: {
            originalSentence: "This coat is not ______ for such cold weather.",
            target: "suitable",
            choices: ["suitable", "popular", "famous", "difficult"],
            meaning: "適した",
            quizTranslation: "このコートは、このような寒い天候には適していない。"
        },
        application: {
            situation: "ある植物を育てるのに最適な場所について話している時。",
            sentence: "This type of plant needs <span class='tooltip-trigger'>rich<span class='tooltip-content'>肥沃な</span></span> <span class='tooltip-trigger'>soil<span class='tooltip-content'>土壌</span></span>, so this sandy <span class='tooltip-trigger'>desert<span class='tooltip-content'>砂漠</span></span> area is not <span class='tooltip-trigger'>suitable<span class='tooltip-content'>適した</span></span> for <span class='tooltip-trigger'>farming<span class='tooltip-content'>農業</span></span> it.",
            translation: "この種の植物は肥沃な土壌を必要とするので、この砂地の砂漠地帯はそれを栽培するのに適していない。"
        },
        flashcards: [
            { en: "desert", ja: "砂漠", kana: "**デ**ザート", phonetic: "/ˈdezərt/", hint: "d" },
            { en: "suitable", ja: "適した", kana: "**スー**タブル", phonetic: "/ˈsuːtəbl/", hint: "s" },
            { en: "farming", ja: "農業", kana: "**ファー**ミング", phonetic: "/ˈfɑːrmɪŋ/", hint: "f" },
            { en: "soil", ja: "土壌", kana: "ソイル", phonetic: "/sɔɪl/", hint: "s" },
            { en: "rich", ja: "肥沃な", kana: "リッチ", phonetic: "/rɪtʃ/", hint: "r" }
        ]
    },
    {
        id: 298,
        originalSentence: "We can't help worrying about global warming.",
        translation: "私たちは地球温暖化のことを心配せずにはいられない。",
        quiz: {
            originalSentence: "I ______ laughing at his jokes.",
            target: "can't help",
            choices: ["can't help", "don't mind", "must not", "should not"],
            meaning: "～せずにはいられない",
            quizTranslation: "彼の冗談には笑わずにはいられなかった。"
        },
        application: {
            situation: "最近の異常気象のニュースを見て、将来が不安になる。",
            sentence: "With all these extreme weather events, you <span class='tooltip-trigger'>can't help<span class='tooltip-content'>～せずにはいられない</span></span> but <span class='tooltip-trigger'>worry<span class='tooltip-content'>心配する</span></span> about the future of our <span class='tooltip-trigger'>global<span class='tooltip-content'>地球の</span></span> climate.",
            translation: "これだけ異常気象の出来事が続くと、地球の気候の未来を心配せずにはいられない。"
        },
        flashcards: [
            { en: "cannot help -ing", ja: "～せずにはいられない", kana: "キャノット・ヘルプ", phonetic: "/ˈkænɑːt help/", hint: "c" },
            { en: "worry", ja: "心配する", kana: "**ウォ**ーリー", phonetic: "/ˈwɜːri/", hint: "w" },
            { en: "global", ja: "地球の", kana: "グ**ロ**ーバル", phonetic: "/ˈɡloʊbl/", hint: "g" }
        ]
    },
    {
        id: 299,
        originalSentence: "The residents protested the construction of the power plant.",
        translation: "住民たちは発電所の建設に抗議した。",
        quiz: {
            originalSentence: "Many local ______ were against the new development project.",
            target: "residents",
            choices: ["residents", "tourists", "workers", "students"],
            meaning: "住民",
            quizTranslation: "多くの地元住民が、その新しい開発プロジェクトに反対していた。"
        },
        application: {
            situation: "新しい工場の建設計画に、地域住民が反対している。",
            sentence: "The local <span class='tooltip-trigger'>residents<span class='tooltip-content'>住民</span></span> are gathering to <span class='tooltip-trigger'>protest<span class='tooltip-content'>～に抗議する</span></span> the <span class='tooltip-trigger'>construction<span class='tooltip-content'>建設</span></span> of the new chemical <span class='tooltip-trigger'>plant<span class='tooltip-content'>工場</span></span>.",
            translation: "地元住民が、新しい化学工場の建設に抗議するために集まっている。"
        },
        flashcards: [
            { en: "resident", ja: "住民", kana: "**レ**ジデント", phonetic: "/ˈrezɪdənt/", hint: "r" },
            { en: "protest", ja: "～に抗議する", kana: "プ**ロ**テスト", phonetic: "/ˈproʊtest/", hint: "p" },
            { en: "construction", ja: "建設", kana: "コンス**トゥ**ラクション", phonetic: "/kənˈstrʌkʃn/", hint: "c" },
            { en: "power", ja: "電力", kana: "**パ**ワー", phonetic: "/ˈpaʊər/", hint: "p" },
            { en: "plant", ja: "工場", kana: "プラント", phonetic: "/plænt/", hint: "p" }
        ]
    },
    {
        id: 300,
        originalSentence: "Garbage was scattered in front of the factory.",
        translation: "工場の正面にゴミが散らかっていた。",
        quiz: {
            originalSentence: "Please don't leave your ______ on the street.",
            target: "garbage",
            choices: ["garbage", "treasure", "money", "food"],
            meaning: "ゴミ",
            quizTranslation: "通りにゴミを放置しないでください。"
        },
        application: {
            situation: "公園のピクニックエリアが散らかっているのを見てがっかりする。",
            sentence: "It's sad to see so much <span class='tooltip-trigger'>garbage<span class='tooltip-content'>ゴミ</span></span> <span class='tooltip-trigger'>scattered<span class='tooltip-content'>散らばっている</span></span> all over the beautiful park.",
            translation: "美しい公園のいたるところにたくさんのゴミが散らかっているのを見るのは悲しいことだ。"
        },
        flashcards: [
            { en: "garbage", ja: "ゴミ", kana: "**ガー**ベッジ", phonetic: "/ˈɡɑːrbɪdʒ/", hint: "g" },
            { en: "scatter", ja: "～をまき散らす", kana: "ス**キャ**ター", phonetic: "/ˈskætər/", hint: "s" },
            { en: "in front of", ja: "～の正面に", kana: "イン・フ**ロ**ント・オブ", phonetic: "/ɪn frʌnt əv/", hint: "i" },
            { en: "factory", ja: "工場", kana: "**ファ**クトリー", phonetic: "/ˈfæktəri/", hint: "f" }
        ]
    }
];

// --- 永続化キー ---
const KEY_PREFIX = 'duoSelect_';
const KEY = `${KEY_PREFIX}progress_v1`;
const VOICE_MODE = `${KEY_PREFIX}voice_mode_v1`;
const CARD_MODE = `${KEY_PREFIX}card_mode_v1`;
const HINT_MODE = `${KEY_PREFIX}hint_mode_v1`;

// --- 永続化とSRSロジック ---
function loadProgress() {
    try {
        return JSON.parse(localStorage.getItem(KEY)) || { cards: {} };
    } catch (e) {
        console.error("Failed to load progress:", e);
        return { cards: {} };
    }
}

function saveProgress(p) {
    try {
        localStorage.setItem(KEY, JSON.stringify(p));
    } catch (e) {
        console.error("Failed to save progress:", e);
    }
}

function isDue(card) {
    return !card || !card.next_due || Date.now() >= card.next_due;
}

function tomorrowPlusDays(n = 0) {
    const d = new Date();
    const t = new Date(d.getFullYear(), d.getMonth(), d.getDate() + 1);
    return t.getTime() + n * 86400000;
}

function markWrong(id) {
    const p = loadProgress();
    const c = p.cards[id] || {};
    c.last_result = 'wrong';
    c.interval = 0;
    c.next_due = Date.now() - 1; // 即座に復習対象にする
    p.cards[id] = c;
    saveProgress(p);
    console.log(`Marked wrong: ${id}`, c);
}

function markCorrect(id) {
    const p = loadProgress();
    const c = p.cards[id] || {};
    c.last_result = 'correct';
    const currentInterval = c.interval || 0;
    const nextInterval = currentInterval === 0 ? 1 : currentInterval === 1 ? 3 : Math.min(currentInterval * 2, 30);
    c.interval = nextInterval;
    c.next_due = tomorrowPlusDays(nextInterval);
    c.done = true;
    p.cards[id] = c;
    saveProgress(p);
    console.log(`Marked correct: ${id}`, c);
}

// --- ID生成 ---
function getItemId(sentenceId, type, identifier = '') {
    let safeIdentifier = identifier.toLowerCase().replace(/[^a-z0-9]/g, '_').substring(0, 20);
    return `s${sentenceId}-${type}${identifier ? `-${safeIdentifier}` : ''}`;
}


// --- 状態管理 ---
let currentSentenceIndex = 0;
let currentStep = 1;
let isSequentialMode = false; 
let speechSynthesis = window.speechSynthesis;
let voiceCache = { male: null, female: null, auto: [], toggle: 0 };
let quizQueue = [];
let stepUnlocked = 1;
let finalCheckCards = [];

// --- DOM要素 ---
const tocScreen = document.getElementById('toc-screen');
const reviewArea = document.getElementById('review-area');
const mainQuizArea = document.getElementById('main-quiz-area');
const finalCheckArea = document.getElementById('final-check-area');
const resultScreen = document.getElementById('result-screen');
const startSequentialBtn = document.getElementById('start-sequential-btn');
const finalCheckBtn = document.getElementById('final-check-btn');
const nextBtn = document.getElementById('next-btn');
const reviewBtn = document.getElementById('review-btn');
const backToTocBtn = document.getElementById('back-to-toc-btn');
const backToTocFromFinalBtn = document.getElementById('back-to-toc-from-final-btn');
const prevSentenceBtn = document.getElementById('prev-sentence-btn');
const nextSentenceBtn = document.getElementById('next-sentence-btn');
const shuffleFinalCheckBtn = document.getElementById('shuffle-final-check-btn');

const stepViews = {
    1: document.getElementById('step1-quiz'),
    2: document.getElementById('step2-application'),
    3: document.getElementById('step3-flashcards'),
};
const stepIndicatorsContainer = document.getElementById('step-indicators-container');

// --- 初期化 ---
document.addEventListener('DOMContentLoaded', async () => {
    if ('speechSynthesis' in window) {
        await pickVoices();
    }
    showMainMenu();
    initAudioControls();
});

// --- イベントリスナー ---
startSequentialBtn.addEventListener('click', () => {
    isSequentialMode = true;
    quizQueue = Array.from(Array(quizData.length).keys());
    startQuizSession(quizQueue);
});

finalCheckBtn.addEventListener('click', () => {
    isSequentialMode = false;
    finalCheckCards = quizData.flatMap(d => 
        d.flashcards.map(fc => ({ ...fc, sentenceId: d.id }))
    );
    finalCheckCards.sort(() => Math.random() - 0.5);
    renderFinalCheck();
});

nextBtn.addEventListener('click', handleNext);
reviewBtn.addEventListener('click', showMainMenu);
backToTocBtn.addEventListener('click', showMainMenu);
backToTocFromFinalBtn.addEventListener('click', showMainMenu);
shuffleFinalCheckBtn.addEventListener('click', () => {
    finalCheckCards.sort(() => Math.random() - 0.5);
    renderFinalCheck();
});

prevSentenceBtn.addEventListener('click', () => {
    if (currentSentenceIndex > 0) {
        navigateToSentence(currentSentenceIndex - 1);
    }
});
nextSentenceBtn.addEventListener('click', () => {
    if (currentSentenceIndex < quizData.length - 1) {
        navigateToSentence(currentSentenceIndex + 1);
    }
});

document.getElementById('header-toc-link').addEventListener('click', (e) => { e.preventDefault(); showMainMenu(); });
document.getElementById('header-review-link').addEventListener('click', (e) => { e.preventDefault(); renderReview(); });
document.getElementById('reset-data-btn').addEventListener('click', () => {
    if (confirm('本当に学習データをすべてリセットしますか？')) {
        localStorage.removeItem(KEY);
        alert('学習データをリセットしました。');
        showMainMenu();
    }
});

stepIndicatorsContainer.addEventListener('click', (e) => {
    if (e.target.matches('.step-indicator')) {
        const targetStep = parseInt(e.target.dataset.step, 10);
        if (targetStep <= stepUnlocked) {
            currentStep = targetStep;
            renderCurrentStep();
        }
    }
});


// --- 音声初期化ロジック ---
function listVoices() {
    return new Promise(resolve => {
        let voices = speechSynthesis.getVoices();
        if (voices.length) {
            return resolve(voices);
        }
        speechSynthesis.onvoiceschanged = () => {
            voices = speechSynthesis.getVoices();
            resolve(voices);
        };
    });
}

function isMobile() {
    const userAgent = navigator.userAgent || navigator.vendor || window.opera;
    return /Mobi|Android|iPhone|iPad|iPod/i.test(userAgent);
}

const SAFE_EN_VOICE_NAMES_PC = [
  "Samantha", "Allison", "Ava", "Alex", "Daniel", "Martha", "Victoria",
  "Microsoft Aria", "Microsoft Zira", "Microsoft Mark", "Microsoft David",
  "Google US English", "Google UK English Female", "Google UK English Male"
];
const BLOCKLIST_KEYWORDS_PC = [
  "Novelty", "Whisper", "Bells", "Cellos", "Bad News", "Good News", "Zarvox",
  "Boing", "Singing", "Cartoon", "Robot", "Buzzer", "Trinoids", "SFX", "Emoji",
  "Sound", "笑", "ロボ", "Fun", "Comic", "effect", "weird", "strange", "echo",
  "chorus", "giggle", "radio", "bad", "poor", "voiceover"
];
function isBlockedVoicePC(v) {
  const nameAndUri = ((v?.name || "") + " " + (v?.voiceURI || "")).toLowerCase();
  return BLOCKLIST_KEYWORDS_PC.some(k => nameAndUri.includes(k.toLowerCase()));
}
function isSafeEnglishVoicePC(v) {
  if (!v || !/^en(-|_)/i.test(v.lang || "")) return false;
  if (isBlockedVoicePC(v)) return false;
  return v.default || SAFE_EN_VOICE_NAMES_PC.some(n => (v.name || "").includes(n));
}
async function getSafeEnglishVoicesPC() {
  const voices = await listVoices();
  const en = (voices || []).filter(v => /^en(-|_)/i.test(v.lang || ""));
  if (!en.length) return [];
  const safe = en.filter(isSafeEnglishVoicePC);
  if (safe.length > 0) return safe;
  const fallback = en.filter(v => !isBlockedVoicePC(v));
  return fallback.length ? fallback : en;
}
async function pickVoicesForPC() {
    const isMaleName = (name = "", uri = "") => /(Daniel|Mark|David|Alex(?!a)|George|Tom|Microsoft Mark|Microsoft David|Google UK English Male|male)/i.test(name) || /male/i.test(uri || "");
    const isFemaleName = (name = "", uri = "") => /(Samantha|Allison|Ava|Victoria|Martha|Aria|Zira|Jenny|Microsoft Aria|Microsoft Zira|Google US English|Google UK English Female|female)/i.test(name) || /female/i.test(uri || "");
    
    const safeVoices = await getSafeEnglishVoicesPC();
    if (safeVoices.length === 0) {
        console.warn("PC: No usable English voices found.");
        return;
    }
    
    voiceCache.auto = [...safeVoices].sort(() => 0.5 - Math.random());
    let specificMale = safeVoices.find(v => isMaleName(v.name, v.voiceURI));
    let specificFemale = safeVoices.find(v => isFemaleName(v.name, v.voiceURI));

    if (!specificMale) specificMale = voiceCache.auto.find(v => !isFemaleName(v.name, v.voiceURI)) || voiceCache.auto[0];
    if (!specificFemale) specificFemale = voiceCache.auto.find(v => v !== specificMale) || voiceCache.auto[1] || voiceCache.auto[0];
    
    voiceCache.male = specificMale || null;
    voiceCache.female = specificFemale || null;
}

async function pickVoicesForMobile() {
    const allVoices = await listVoices();
    const enVoices = allVoices.filter(v => v.lang.startsWith('en-'));
    if (enVoices.length === 0) {
        console.warn("Mobile: No English voices found.");
        return;
    }
    
    let maleVoice = enVoices.find(v => v.name === "Daniel") || enVoices.find(v => v.name.toLowerCase().includes('male'));
    let femaleVoice = enVoices.find(v => v.name === "Samantha") || enVoices.find(v => v.name.toLowerCase().includes('female'));

    if (!maleVoice) maleVoice = enVoices.find(v => !v.name.toLowerCase().includes('female')) || enVoices[0];
    if (!femaleVoice) femaleVoice = enVoices.find(v => v !== maleVoice) || enVoices.find(v => !v.name.toLowerCase().includes('male')) || enVoices[0];
    
    voiceCache.male = maleVoice || null;
    voiceCache.female = femaleVoice || null;
    
    const autoVoices = [];
    if (maleVoice) autoVoices.push(maleVoice);
    if (femaleVoice && femaleVoice !== maleVoice) autoVoices.push(femaleVoice);
    
    voiceCache.auto = autoVoices.length > 0 ? autoVoices : [enVoices[0]].filter(Boolean);
}

async function pickVoices() {
    try {
        if (isMobile()) {
            await pickVoicesForMobile();
        } else {
            await pickVoicesForPC();
        }
        if (!voiceCache.auto || voiceCache.auto.length === 0) {
             const allVoices = await listVoices();
             const enVoices = allVoices.filter(v => v.lang.startsWith('en-'));
             if(enVoices.length > 0) {
                voiceCache.auto = [enVoices[0]];
             } else {
                voiceCache.auto = allVoices.length > 0 ? [allVoices[0]] : [];
             }
        }
        if (!voiceCache.male) voiceCache.male = voiceCache.auto[0] || null;
        if (!voiceCache.female) voiceCache.female = voiceCache.auto.find(v => v !== voiceCache.male) || voiceCache.auto[0] || null;
    } catch (e) {
        console.error('Error picking voices', e);
        const allVoices = speechSynthesis.getVoices();
        const enVoice = allVoices.find(v => v.lang.startsWith('en-')) || allVoices[0];
        if (enVoice) {
            voiceCache.male = enVoice;
            voiceCache.female = enVoice;
            voiceCache.auto = [enVoice];
        }
    }
}

function navigateToSentence(index) {
    if (index < 0 || index >= quizData.length) return;

    isSequentialMode = false;
    quizQueue = [];

    currentSentenceIndex = index;
    currentStep = 1;
    stepUnlocked = 3;
    renderCurrentStep();
}

function initAudioControls() {
    const voiceSeg = document.getElementById('voiceSeg');
    if (voiceSeg) {
        voiceSeg.addEventListener('click', (e) => {
            const v = e.target?.dataset?.v;
            if (!v) return;
            localStorage.setItem(VOICE_MODE, v);
            syncAppSettings();
        });
    }

    const cardModeSeg = document.getElementById('cardModeSeg');
    if (cardModeSeg) {
        cardModeSeg.addEventListener('click', (e) => {
            const v = e.target?.dataset?.v;
            if (!v) return;
            localStorage.setItem(CARD_MODE, v);
            syncAppSettings();
        });
    }

    const hintModeSeg = document.getElementById('hintModeSeg');
    if (hintModeSeg) {
        hintModeSeg.addEventListener('click', (e) => {
            const v = e.target?.dataset?.v;
            if (!v) return;
            localStorage.setItem(HINT_MODE, v);
            syncAppSettings();
        });
    }

    syncAppSettings();
}

function syncAppSettings() {
    const voiceSeg = document.getElementById('voiceSeg');
    if (voiceSeg) {
        const currentVoiceMode = localStorage.getItem(VOICE_MODE) || 'auto';
        [...voiceSeg.querySelectorAll('button')].forEach(b => b.classList.toggle('on', b.dataset.v === currentVoiceMode));
    }
    
    const cardModeSeg = document.getElementById('cardModeSeg');
    const currentCardMode = localStorage.getItem(CARD_MODE) || 'en-ja';
    if (cardModeSeg) {
        [...cardModeSeg.querySelectorAll('button')].forEach(b => b.classList.toggle('on', b.dataset.v === currentCardMode));
    }

    const finalCheckDescription = document.getElementById('final-check-description');
    if (finalCheckDescription) {
        if (currentCardMode === 'ja-en') {
            finalCheckDescription.textContent = '日本語を見て、対応する英単語を思い出してみましょう。カードをタップすると答えが表示されます。';
        } else {
            finalCheckDescription.textContent = '英語を見て、対応する日本語を思い出してみましょう。カードをタップすると答えが表示されます。';
        }
    }

    const hintModeSeg = document.getElementById('hintModeSeg');
    if (hintModeSeg) {
        const currentHintMode = localStorage.getItem(HINT_MODE) || 'on';
        const isHintingDisabled = currentCardMode === 'en-ja';
        
        hintModeSeg.style.opacity = isHintingDisabled ? '0.5' : '1';
        [...hintModeSeg.querySelectorAll('button')].forEach(b => {
            b.classList.toggle('on', b.dataset.v === currentHintMode);
            b.disabled = isHintingDisabled;
        });
    }
}

// --- 関数 ---

function sanitizeForTTS(s) {
    if (!s) return s;
    let t = s.replace(/\([^)]*\)/g, '').replace(/（[^）]*）/g, '');
    t = t.replace(/<[^>]+>/g, '');
    t = t.replace(/[↔↮→—–…\/｜≠=]/g, ' ');
    t = t.replace(/[\u3040-\u30FF\u3400-\u9FFF\uF900-\uFAFF]/g, '');
    t = t.replace(/\s{2,}/g, ' ').trim();
    return t;
}

function getVoiceMode() { return localStorage.getItem(VOICE_MODE) || 'auto' }

function speak(text) {
    if (!('speechSynthesis' in window) || !text) return;
    try { speechSynthesis.cancel(); } catch (e) { }
    
    const prepared = sanitizeForTTS(text);
    if (!prepared) return;

    const rateEl = document.getElementById('rate');
    const rawRate = rateEl ? parseFloat(rateEl.value) : 1.0;
    const mode = getVoiceMode();

    const clamp = (val, min, max) => Math.max(min, Math.min(max, val));

    let voiceToUse = null;
    if (mode === 'male') {
        voiceToUse = voiceCache.male;
    } else if (mode === 'female') {
        voiceToUse = voiceCache.female;
    } else {
        if (voiceCache.auto.length > 0) {
            voiceCache.toggle = (voiceCache.toggle + 1) % voiceCache.auto.length;
            voiceToUse = voiceCache.auto[voiceCache.toggle];
        }
    }
    
    const u = new SpeechSynthesisUtterance(prepared);
    u.lang = 'en-US';
    u.rate = clamp(rawRate, 0.8, 1.2); 
    u.pitch = clamp(1.0, 0.85, 1.15); 
    u.voice = voiceToUse;
    
    if (u.voice || speechSynthesis.getVoices().length > 0) {
        speechSynthesis.speak(u);
    } else {
        setTimeout(() => {
            if (!u.voice) {
                 if (mode === 'male') voiceToUse = voiceCache.male;
                 else if (mode === 'female') voiceToUse = voiceCache.female;
                 else if (voiceCache.auto.length) voiceToUse = voiceCache.auto[voiceCache.toggle];
                 u.voice = voiceToUse;
            }
            speechSynthesis.speak(u);
        }, 250);
    }
}

function showMainMenu() {
    resultScreen.classList.add('hidden');
    mainQuizArea.classList.add('hidden');
    finalCheckArea.classList.add('hidden');
    reviewArea.classList.add('hidden');
    tocScreen.classList.remove('hidden');
    
    const tocList = document.getElementById('toc-list');
    tocList.innerHTML = '';
    const progress = loadProgress();

    const allDue = Object.keys(progress.cards).filter(id => isDue(progress.cards[id]));
    const urgent = allDue.filter(id => progress.cards[id].last_result === 'wrong');
    const scheduled = allDue.filter(id => progress.cards[id].last_result !== 'wrong');
    
    const reviewBannerContainer = document.getElementById('review-banner-container');
    const headerReviewBadge = document.getElementById('header-review-badge');

    if (allDue.length > 0) {
        reviewBannerContainer.innerHTML = `
            <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-lg cursor-pointer hover:bg-yellow-200" id="start-review-btn">
                <p class="font-bold">今日の復習があります！</p>
                <p>期限が来たカードが <span class="font-bold">${allDue.length}</span> 件あります。（要復習: ${urgent.length}件 / 再確認: ${scheduled.length}件）</p>
            </div>
        `;
        document.getElementById('start-review-btn').addEventListener('click', renderReview);
        headerReviewBadge.textContent = allDue.length;
        headerReviewBadge.classList.remove('hidden');
    } else {
        reviewBannerContainer.innerHTML = '';
        headerReviewBadge.classList.add('hidden');
    }


    quizData.forEach((data, index) => {
        const quizId = getItemId(data.id, 'quiz');
        const cardIds = data.flashcards.map(fc => getItemId(data.id, 'card', fc.en));
        
        const isQuizDue = progress.cards[quizId] && isDue(progress.cards[quizId]);
        const isVocabDue = cardIds.some(cardId => progress.cards[cardId] && isDue(progress.cards[cardId]));
        const hasDueItems = isQuizDue || isVocabDue;

        const item = document.createElement('button');
        item.className = 'toc-item p-3 border rounded-lg text-center hover:bg-gray-100 transition-colors flex flex-col justify-center items-center h-full';
        if (hasDueItems) item.classList.add('needs-review', 'border-red-400', 'bg-red-50');
        
        let reviewMarksHTML = '<div class="flex items-center space-x-1 mt-1">';
        if (isQuizDue) reviewMarksHTML += '<span class="review-mark" title="クイズ要復習">Q</span>';
        if (isVocabDue) reviewMarksHTML += '<span class="review-mark bg-sky-500" title="単語要復習">V</span>';
        reviewMarksHTML += '</div>';

        item.innerHTML = `
            <div class="toc-item-content">
                <span class="font-semibold">例文 ${data.id}</span>
                ${hasDueItems ? reviewMarksHTML : ''}
            </div>
        `;
        item.onclick = () => {
            isSequentialMode = false;
            startQuizSession([index]);
        };
        tocList.appendChild(item);
    });
}


function startQuizSession(indices) {
    if (indices.length === 0) {
        showMainMenu();
        return;
    }
    
    currentSentenceIndex = indices.shift();
    quizQueue = indices;
    
    currentStep = 1;
    if (isSequentialMode) {
        stepUnlocked = 1;
    } else {
        stepUnlocked = 3;
    }
    
    tocScreen.classList.add('hidden');
    resultScreen.classList.add('hidden');
    mainQuizArea.classList.remove('hidden');
    nextBtn.classList.add('hidden');
    renderCurrentStep();
}

function handleNext() {
    currentStep++;
    stepUnlocked = Math.max(stepUnlocked, currentStep);

    if (currentStep > 3) {
        if (quizQueue.length > 0) {
            currentSentenceIndex = quizQueue.shift();
            currentStep = 1;
            renderCurrentStep();
        } else {
            if (isSequentialMode) {
                 showResult();
            } else {
                showMainMenu();
            }
        }
    } else {
        renderCurrentStep();
    }
}


function updateProgress() {
    const currentData = quizData[currentSentenceIndex];
    if (!currentData) return; 

    document.getElementById('question-counter').textContent = `例文 ${currentData.id}`;
    
    if (isSequentialMode) {
        const totalQuestions = quizData.length;
        const completedQuestions = totalQuestions - quizQueue.length - 1;
        const progress = (completedQuestions / totalQuestions) * 100;
        document.getElementById('progress-bar').style.width = `${progress}%`;
        document.getElementById('progress-bar').classList.remove('hidden');

    } else {
        document.getElementById('progress-bar').classList.add('hidden');
    }

    [...stepIndicatorsContainer.children].forEach(el => {
        const step = parseInt(el.dataset.step, 10);
        el.classList.remove('active', 'cursor-pointer', 'hover:bg-gray-200');
        el.disabled = step > stepUnlocked;

        if (step === currentStep) {
            el.classList.add('active');
        } else if (step < stepUnlocked) {
            el.classList.add('cursor-pointer', 'hover:bg-gray-200');
        }
    });
}

function updateSentenceNav() {
    const sentenceNav = document.getElementById('sentence-nav');
    if (isSequentialMode) {
        sentenceNav.classList.add('hidden');
    } else {
        sentenceNav.classList.remove('hidden');
        prevSentenceBtn.disabled = currentSentenceIndex === 0;
        nextSentenceBtn.disabled = currentSentenceIndex === quizData.length - 1;
    }
}

function renderCurrentStep() {
    updateProgress();
    Object.values(stepViews).forEach(view => view.classList.add('hidden'));
    if (stepViews[currentStep]) {
        stepViews[currentStep].classList.remove('hidden');
    }
    nextBtn.classList.add('hidden');
    updateSentenceNav();

    const data = quizData[currentSentenceIndex];
    if (!data) return; 

    switch (currentStep) {
        case 1: renderStep1(data); break;
        case 2: renderStep2(data); break;
        case 3: renderStep3(data); break;
    }
}

function renderStep1(data) {
    const { quiz } = data;
    const questionText = quiz.originalSentence.replace(new RegExp(quiz.target.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1"), 'i'), '______');
    const shuffledChoices = [...quiz.choices].sort(() => Math.random() - 0.5);
    const correctSentenceForTTS = quiz.originalSentence.replace(/_{2,}/, quiz.target);
    
    let optionsHTML = shuffledChoices.map(choice => 
        `<button class="btn-option w-full p-4 bg-white border border-gray-300 rounded-lg text-left text-gray-700 font-medium transition-all duration-200 flex items-center min-h-[4rem]">${choice}</button>`
    ).join('');

    stepViews[1].innerHTML = `
        <p class="text-sm text-gray-500 text-center mb-4">あてはまる選択肢を選びましょう。</p>
        <div class="mb-6 relative">
            <p class="text-xl md:text-2xl text-gray-800 text-center p-4 bg-gray-50 rounded-lg">${questionText}</p>
            <button onclick="speak('${correctSentenceForTTS.replace(/'/g, "\\'")}')" class="absolute top-1/2 right-4 -translate-y-1/2 text-gray-500 hover:text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.858 12H4a1 1 0 00-1 1v2a1 1 0 001 1h1.858l4.242 4.243A1 1 0 0012 20.485V3.515a1 1 0 00-1.9-1.414L5.858 12z" /></svg>
            </button>
        </div>
        <div id="step1-options" class="grid grid-cols-1 md:grid-cols-2 gap-4">${optionsHTML}</div>
        <div id="step1-feedback" class="p-4 rounded-lg text-center font-medium hidden my-4"></div>
    `;

    document.getElementById('step1-options').addEventListener('click', e => {
        const button = e.target.closest('.btn-option');
        if (button) {
            handleQuizAnswer(button, quiz);
        }
    });
}

function handleQuizAnswer(selectedButton, quizInfo) {
    const isCorrect = selectedButton.innerText.toLowerCase() === quizInfo.target.toLowerCase();
    const itemId = getItemId(quizData[currentSentenceIndex].id, 'quiz');
    
    if (isCorrect) {
        markCorrect(itemId);
    } else {
        markWrong(itemId);
    }
    
    const feedbackEl = document.getElementById('step1-feedback');
    
    if (isCorrect) {
        feedbackEl.innerHTML = `正解！ <span class="font-bold">${quizInfo.target}</span> は「${quizInfo.meaning}」という意味です。`;
        feedbackEl.className = 'p-4 rounded-lg text-center font-medium my-4 bg-green-100 border border-green-300 text-green-800';
    } else {
        feedbackEl.innerHTML = `不正解。正解は <span class="font-bold">${quizInfo.target}</span> です。<br>「${quizInfo.meaning}」という意味になります。`;
        feedbackEl.className = 'p-4 rounded-lg text-center font-medium my-4 bg-red-100 border border-red-300 text-red-800';
    }
    feedbackEl.classList.remove('hidden');
    
    if (quizInfo.quizTranslation) {
        const quizTranslationEl = document.createElement('p');
        quizTranslationEl.className = 'text-center text-gray-600 mt-2';
        quizTranslationEl.textContent = `クイズ文の訳：${quizInfo.quizTranslation}`;
        feedbackEl.appendChild(quizTranslationEl);
    }

    Array.from(document.getElementById('step1-options').children).forEach(button => {
        button.disabled = true;
        if (button.innerText.toLowerCase() === quizInfo.target.toLowerCase()) button.classList.add('bg-green-200', 'border-green-500');
        else if (button === selectedButton) button.classList.add('bg-red-200', 'border-red-500');
    });

    nextBtn.textContent = '応用例文へ →';
    nextBtn.classList.remove('hidden');
}

function renderStep2(data) {
    const { application } = data;
    stepViews[2].innerHTML = `
        <p class="text-sm text-gray-500 text-center mb-4">応用例文で使い方を確認しましょう。</p>
        <div class="bg-sky-50 border-l-4 border-sky-500 p-4 rounded-lg mb-4">
            <p class="font-semibold text-sky-800 mb-2">💡 こんな場面で使える！</p>
            <p class="text-gray-700">${application.situation}</p>
        </div>
        <div class="mb-4 relative p-4 bg-gray-50 rounded-lg">
            <p class="text-lg md:text-xl text-gray-800">${application.sentence}</p>
            <button class="speaker-btn text-xl" onclick="speak(this.previousElementSibling.innerText.replace(/'/g, &quot;\\'&quot;))"><i class="fas fa-volume-up"></i></button>
        </div>
        <div class="text-center mb-6">
            <button id="show-translation-btn" class="text-blue-600 hover:underline">日本語訳を見る</button>
        </div>
        <p id="translation-text" class="text-center text-gray-600 hidden mb-6">${application.translation}</p>
    `;

    stepViews[2].querySelector('#show-translation-btn').addEventListener('click', e => {
        document.getElementById('translation-text').classList.toggle('hidden');
        e.target.textContent = document.getElementById('translation-text').classList.contains('hidden') ? '日本語訳を見る' : '日本語訳を隠す';
    });

    nextBtn.textContent = '単語カードへ →';
    nextBtn.classList.remove('hidden');
    stepUnlocked = Math.max(stepUnlocked, 3);
    updateProgress();
}

function renderFlashcards(container, cards, isFinalCheck = false) {
    container.innerHTML = '';
    const progress = loadProgress();

    const savedCardMode = localStorage.getItem(CARD_MODE) || 'en-ja';
    const savedHintMode = localStorage.getItem(HINT_MODE) || 'on';
    const isHintVisible = (savedCardMode === 'ja-en' && savedHintMode === 'on');

    cards.forEach(card => {
        const sentenceId = isFinalCheck ? card.sentenceId : quizData[currentSentenceIndex].id;
        const cardId = getItemId(sentenceId, 'card', card.en);
        const cardProgress = progress.cards[cardId];
        
        const cardEl = document.createElement('div');
        cardEl.className = 'flex flex-col gap-2';
        
        const flashcardDiv = document.createElement('div');
        flashcardDiv.className = 'flashcard h-48 relative';

        let statusBadgeHTML = '';
        if (cardProgress && isDue(cardProgress) && cardProgress.last_result === 'wrong') {
            statusBadgeHTML = '<span class="absolute top-2 left-2 text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded-full z-10">要復習</span>';
        } else if (cardProgress && isDue(cardProgress)) {
            statusBadgeHTML = '<span class="absolute top-2 left-2 text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full z-10">再確認</span>';
        } else if (cardProgress && cardProgress.done) {
            statusBadgeHTML = '<span class="absolute top-2 left-2 text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full z-10">できた</span>';
        }

        const frontContent = (savedCardMode === 'en-ja') 
            ? `<h3 class="text-2xl font-bold">${card.en}</h3>`
            : `<h3 class="text-xl font-bold">${card.ja}</h3>${isHintVisible ? `<p class="text-gray-500 mt-2">ヒント: ${card.hint}</p>` : ''}`;
        
        const backContent = (savedCardMode === 'en-ja')
            ? `<h3 class="text-xl font-bold">${card.ja}</h3>`
            : `<h3 class="text-2xl font-bold">${card.en}</h3>`;

        flashcardDiv.innerHTML = `
            ${statusBadgeHTML}
            <div class="flashcard-inner">
                <div class="flashcard-front">${frontContent}<button class="speaker-btn"><i class="fas fa-volume-up"></i></button></div>
                <div class="flashcard-back">
                    ${backContent}
                    <div class="text-center mt-2">
                        <p class="text-gray-500">${card.kana.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')}</p>
                        <p class="text-gray-400 text-sm">${card.phonetic}</p>
                    </div>
                    <button class="speaker-btn"><i class="fas fa-volume-up"></i></button>
                </div>
            </div>
        `;
        flashcardDiv.addEventListener('click', () => flashcardDiv.classList.toggle('flipped'));
        flashcardDiv.querySelectorAll('.speaker-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                speak(card.en);
            });
        });
        
        const buttonContainer = document.createElement('div');
        buttonContainer.className = 'grid grid-cols-2 gap-2';
        
        const correctBtn = document.createElement('button');
        correctBtn.textContent = 'できた';
        correctBtn.className = 'w-full py-2 px-4 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors';
        correctBtn.onclick = (e) => {
            e.stopPropagation();
            markCorrect(cardId);
            if (isFinalCheck) {
                renderFinalCheck();
            } else {
                renderCurrentStep();
            }
        };

        const wrongBtn = document.createElement('button');
        wrongBtn.textContent = 'あとで復習';
        wrongBtn.className = 'w-full py-2 px-4 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors';
        wrongBtn.onclick = (e) => {
            e.stopPropagation();
            markWrong(cardId);
            if (isFinalCheck) {
                renderFinalCheck();
            } else {
                renderCurrentStep();
            }
        };

        buttonContainer.append(wrongBtn, correctBtn);
        cardEl.append(flashcardDiv, buttonContainer);
        container.appendChild(cardEl);
    });
}

function renderStep3(data) {
    const { flashcards } = data;
    
    stepViews[3].innerHTML = `
        <p class="text-sm text-gray-500 text-center mb-4">カードをタップして関連単語も覚えましょう。</p>
        <div id="flashcard-container-step3" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    `;

    const container = document.getElementById('flashcard-container-step3');
    renderFlashcards(container, flashcards);

    const nextText = quizQueue.length === 0 ? 
        (isSequentialMode ? '結果を見る' : '目次に戻る') : 
        '次の問題へ →';
    nextBtn.textContent = nextText;
    nextBtn.classList.remove('hidden');
}

function renderFinalCheck() {
    tocScreen.classList.add('hidden');
    mainQuizArea.classList.add('hidden');
    resultScreen.classList.add('hidden');
    finalCheckArea.classList.remove('hidden');
    syncAppSettings();

    const container = document.getElementById('final-check-flashcards');
    renderFlashcards(container, finalCheckCards, true);
}

function showResult() {
    mainQuizArea.classList.add('hidden');
    resultScreen.classList.remove('hidden');
    
    const summaryEl = document.getElementById('self-assessment-summary');
    summaryEl.innerHTML = `
        <p class="text-xl">お疲れ様でした！</p>
        <p class="text-gray-600 mt-2">間違えた問題や「あとで復習」を選んだ問題は、目次画面から再度挑戦できます。</p>
    `;
}

function renderReview() {
    tocScreen.classList.add('hidden');
    mainQuizArea.classList.add('hidden');
    finalCheckArea.classList.add('hidden');
    reviewArea.classList.remove('hidden');

    const progress = loadProgress();
    const allDue = Object.keys(progress.cards).filter(id => isDue(progress.cards[id]));
    const urgent = allDue.filter(id => progress.cards[id].last_result === 'wrong').sort((a,b) => (progress.cards[a].next_due || 0) - (progress.cards[b].next_due || 0));
    const scheduled = allDue.filter(id => progress.cards[id].last_result !== 'wrong').sort((a,b) => (progress.cards[a].next_due || 0) - (progress.cards[b].next_due || 0));
    
    const reviewQueue = [...urgent, ...scheduled];
    let currentIndex = 0;

    function findDataById(itemId) {
        const parts = itemId.split('-');
        const sentenceId = parseInt(parts[0].substring(1), 10);
        const type = parts[1];
        const sentenceData = quizData.find(d => d.id === sentenceId);
        if (!sentenceData) return null;

        if (type === 'quiz') {
            return { type, sentence: sentenceData, quiz: sentenceData.quiz };
        }
        if (type === 'card') {
            const identifier = parts.slice(2).join('-');
            const cardData = sentenceData.flashcards.find(fc => fc.en.toLowerCase().replace(/[^a-z0-9]/g, '_').substring(0, 20) === identifier);
            return { type, sentence: sentenceData, card: cardData };
        }
        return null;
    }

    function renderNextItem() {
        if (currentIndex >= reviewQueue.length) {
            reviewArea.innerHTML = `
                <div class="text-center">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">復習完了！</h2>
                    <p class="text-gray-600 mb-6">お疲れ様でした。すべての復習項目が終わりました。</p>
                    <button id="review-back-to-toc" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full">目次に戻る</button>
                </div>
            `;
            document.getElementById('review-back-to-toc').addEventListener('click', showMainMenu);
            return;
        }

        const itemId = reviewQueue[currentIndex];
        const itemData = findDataById(itemId);

        if (!itemData || (itemData.type === 'card' && !itemData.card)) {
            console.warn(`Could not find data for review item: ${itemId}. Skipping.`);
            currentIndex++;
            renderNextItem();
            return;
        }

        reviewArea.innerHTML = `
            <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6">
                <div class="bg-blue-500 h-2.5 rounded-full" style="width: ${((currentIndex) / reviewQueue.length) * 100}%; transition: width 0.3s;"></div>
            </div>
            <div id="review-item-content"></div>
        `;
        const contentEl = document.getElementById('review-item-content');

        const advance = () => {
            currentIndex++;
            setTimeout(renderNextItem, 600);
        };

        if (itemData.type === 'quiz') {
            const { sentence, quiz } = itemData;
            const questionText = quiz.originalSentence.replace(new RegExp(quiz.target.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1"), 'i'), '______');
            const shuffledChoices = [...quiz.choices].sort(() => Math.random() - 0.5);
            let optionsHTML = shuffledChoices.map(choice => 
                `<button class="btn-option w-full p-3 bg-white border border-gray-300 rounded-lg text-left text-gray-700 font-medium flex items-center min-h-[3.5rem]">${choice}</button>`
            ).join('');

            contentEl.innerHTML = `
                <p class="text-sm text-gray-500 mb-2">例文 ${sentence.id} - 空所補充</p>
                <div class="mb-4 relative">
                    <p class="text-lg text-gray-800 text-center p-4 bg-gray-50 rounded-lg">${questionText}</p>
                    <button id="review-quiz-tts-btn" class="speaker-btn"><i class="fas fa-volume-up"></i></button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="review-options">
                    ${optionsHTML}
                </div>
            `;
            contentEl.querySelector('#review-quiz-tts-btn').addEventListener('click', () => speak(quiz.originalSentence));

            contentEl.querySelector('#review-options').addEventListener('click', (e) => {
                const button = e.target.closest('.btn-option');
                if (button) {
                    const isCorrect = button.innerText.toLowerCase() === quiz.target.toLowerCase();
                    if (isCorrect) markCorrect(itemId); else markWrong(itemId);
                    
                    Array.from(contentEl.querySelector('#review-options').children).forEach(btn => {
                        btn.disabled = true;
                        if (btn.innerText.toLowerCase() === quiz.target.toLowerCase()) btn.classList.add('!bg-green-200', '!border-green-500');
                        else if (btn === button) btn.classList.add('!bg-red-200', '!border-red-500');
                    });
                    advance();
                }
            });
        } else if (itemData.type === 'card') {
            const { card } = itemData;
            const cardContainer = document.createElement('div');
            const originalIndex = currentSentenceIndex;
            currentSentenceIndex = quizData.findIndex(d => d.id === itemData.sentence.id);
            renderFlashcards(cardContainer, [card]); 
            currentSentenceIndex = originalIndex;

            contentEl.innerHTML = `<p class="text-sm text-gray-500 mb-2">例文 ${itemData.sentence.id} - 単語カード</p>`;
            contentEl.appendChild(cardContainer);

            const correctBtn = cardContainer.querySelector('.bg-green-500');
            const wrongBtn = cardContainer.querySelector('.border-gray-300');
            if (correctBtn) correctBtn.onclick = (e) => { e.stopPropagation(); markCorrect(itemId); correctBtn.style.opacity = '1'; wrongBtn.style.opacity = '0.5'; advance(); };
            if (wrongBtn) wrongBtn.onclick = (e) => { e.stopPropagation(); markWrong(itemId); wrongBtn.style.opacity = '1'; correctBtn.style.opacity = '0.5'; advance(); };
        }
    }

    if (reviewQueue.length > 0) {
        renderNextItem();
    } else {
        reviewArea.innerHTML = `
             <div class="text-center">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">今日の復習はありません</h2>
                <p class="text-gray-600 mb-6">素晴らしいです！復習が必要な項目は今のところありません。</p>
                <button id="review-back-to-toc" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full">目次に戻る</button>
            </div>
        `;
        document.getElementById('review-back-to-toc').addEventListener('click', showMainMenu);
    }
}
</script>
</body>
</html>
