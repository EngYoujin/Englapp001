<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DUOã‚»ãƒ¬ã‚¯ãƒˆè‹±å˜èªã‚¯ã‚¤ã‚º (ä¾‹æ–‡ 31-40)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', 'Inter', sans-serif; }
        .quiz-container { max-width: 800px; width: 95%; }
        .step-indicator.active { background-color: #3b82f6; color: white; font-weight: bold; }
        .btn-option:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .flashcard { perspective: 1000px; cursor: pointer; }
        .flashcard-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .flashcard.flipped .flashcard-inner { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 1rem; border-radius: 0.75rem; border: 1px solid #d1d5db; }
        .flashcard-front { background-color: white; }
        .flashcard-back { background-color: #f0f9ff; transform: rotateY(180deg); }
        .speaker-btn { position: absolute; top: 10px; right: 10px; color: #6b7280; }
        .speaker-btn:hover { color: #3b82f6; }
        .tooltip-trigger { border-bottom: 2px dotted #3b82f6; cursor: pointer; position: relative; }
        .tooltip-content { visibility: hidden; width: max-content; max-width: 250px; background-color: #1f2937; color: #fff; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 1; bottom: 125%; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .tooltip-trigger:hover .tooltip-content { visibility: visible; opacity: 1; }
        .review-mark {
            display: inline-block;
            font-size: 0.7rem;
            font-weight: bold;
            color: white;
            background-color: #ef4444;
            border-radius: 9999px;
            width: 1.1rem;
            height: 1.1rem;
            line-height: 1.1rem;
            text-align: center;
            margin-left: 0.25rem;
        }
        .toc-item-content {
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="quiz-container mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-8">
        
        <!-- Table of Contents Screen (Main Menu) -->
        <div id="toc-screen">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 text-center mb-4">DUOã‚»ãƒ¬ã‚¯ãƒˆå­¦ç¿’ (31-40)</h1>
            <p class="text-gray-600 text-center mb-8">å­¦ç¿’ã—ãŸã„ä¾‹æ–‡ã‚’é¸ã¶ã‹ã€æœ€åˆã‹ã‚‰å…¨ã¦ã®å•é¡Œã«æŒ‘æˆ¦ã—ã¾ã—ã‚‡ã†ã€‚</p>
            
            <div class="border-b pb-8 mb-8">
                <h2 class="text-lg font-bold text-gray-700 text-center mb-4">ãƒ¡ã‚¤ãƒ³å­¦ç¿’</h2>
                <button id="start-sequential-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-full text-lg transition-transform transform hover:scale-105">
                    æœ€åˆã‹ã‚‰é †ç•ªã«å…¨ã¦ã®å•é¡Œã‚’ã‚„ã‚‹
                </button>
            </div>

            <div>
                <h2 class="text-lg font-bold text-gray-700 text-center mb-4">å€‹åˆ¥å­¦ç¿’ãƒ»å¾©ç¿’</h2>
                <div id="toc-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
            </div>
            
            <div class="border-t pt-8 mt-8">
                 <h2 class="text-lg font-bold text-gray-700 text-center mb-4">è…•è©¦ã—</h2>
                 <button id="final-check-btn" class="w-full bg-white hover:bg-gray-100 text-gray-700 font-semibold py-2 px-6 border border-gray-300 rounded-full">
                    ã¾ã¨ã‚ã¦æœ€çµ‚ãƒã‚§ãƒƒã‚¯ (æ—¥â†’è‹±)
                </button>
            </div>
        </div>

        <!-- Main Quiz Area -->
        <div id="main-quiz-area" class="hidden">
            <!-- Progress and Title -->
            <div class="flex justify-between items-center mb-2">
                 <button id="back-to-toc-btn" class="text-blue-500 hover:text-blue-700 font-semibold"><i class="fas fa-arrow-left mr-2"></i>ç›®æ¬¡ã«æˆ»ã‚‹</button>
                <p id="question-counter" class="text-gray-500 font-medium"></p>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
                <div id="progress-bar" class="bg-blue-500 h-2.5 rounded-full" style="width: 0%; transition: width 0.3s ease-in-out;"></div>
            </div>
            <!-- Step Indicators -->
            <div class="flex justify-center space-x-1 md:space-x-2 mb-6 text-xs md:text-sm">
                <div id="step-indicator-1" class="step-indicator border border-gray-300 rounded-full px-3 py-1 text-gray-600 transition-all duration-300">1:ã‚¯ã‚¤ã‚º</div>
                <div id="step-indicator-2" class="step-indicator border border-gray-300 rounded-full px-3 py-1 text-gray-600 transition-all duration-300">2:å¿œç”¨</div>
                <div id="step-indicator-3" class="step-indicator border border-gray-300 rounded-full px-3 py-1 text-gray-600 transition-all duration-300">3:å¾©ç¿’</div>
            </div>

            <!-- Step Views -->
            <div id="step-views">
                <div id="step1-quiz" class="step-view"></div>
                <div id="step2-application" class="step-view hidden"></div>
                <div id="step3-flashcards" class="step-view hidden"></div>
            </div>
            
            <!-- Navigation -->
            <div class="text-center mt-6">
                <button id="next-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-8 rounded-full transition-colors hidden">æ¬¡ã¸</button>
            </div>
        </div>
        
        <!-- Final Check Area -->
        <div id="final-check-area" class="hidden">
            <div class="flex justify-between items-center mb-4">
                 <button id="back-to-toc-from-final-btn" class="text-blue-500 hover:text-blue-700 font-semibold"><i class="fas fa-arrow-left mr-2"></i>ç›®æ¬¡ã«æˆ»ã‚‹</button>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-4">ã¾ã¨ã‚ã¦æœ€çµ‚ãƒã‚§ãƒƒã‚¯</h2>
            <p class="text-sm text-gray-500 text-center mb-6">æ—¥æœ¬èªã‚’è¦‹ã¦ã€å¯¾å¿œã™ã‚‹è‹±å˜èªã‚’æ€ã„å‡ºã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ã‚«ãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ç­”ãˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
            <div id="final-check-flashcards" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>

        <!-- Result Screen -->
        <div id="result-screen" class="hidden text-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-4">å…¨å•çµ‚äº†ï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼</h2>
            <p class="text-lg text-gray-700 mb-6">å­¦ç¿’çµæœã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚</p>
            <div id="self-assessment-summary"></div>
            <div class="mt-8">
                <button id="review-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-full text-lg transition-transform transform hover:scale-105 mr-4">ç›®æ¬¡ã§å¾©ç¿’ã™ã‚‹</button>
            </div>
        </div>
    </div>

<script>
// --- DATA ---
const quizData = [
    {
        id: 31,
        originalSentence: "Many people believed the myth that the financial institution was too big to go bankrupt.",
        translation: "å¤šãã®äººã€…ãŒã€ãã®é‡‘èæ©Ÿé–¢ã¯å¤§ãã™ãã¦å€’ç”£ã—ãªã„ã¨ã„ã†ç¥è©±ã‚’ä¿¡ã˜ã¦ã„ãŸã€‚",
        quiz: { target: "bankrupt", choices: ["bankrupt", "intense", "solid", "vague"], meaning: "ç ´ç”£ã—ãŸ" },
        application: {
            situation: "ğŸ’¡ ã“ã‚“ãªå ´é¢ã§ä½¿ãˆã‚‹ï¼<br>äººæ°—ã ã£ãŸã‚¿ãƒ”ã‚ªã‚«å±‹ã•ã‚“ãŒã€æ°—ã¥ã„ãŸã‚‰é–‰åº—ã—ã¦ã„ãŸã€‚",
            sentence: "That <span class='tooltip-trigger'>bubble tea<span class='tooltip-content'>bubble tea = ã‚¿ãƒ”ã‚ªã‚«ãƒ†ã‚£ãƒ¼</span></span> shop that was so popular went <span class='tooltip-trigger'>bankrupt<span class='tooltip-content'>ç ´ç”£ã—ãŸ</span></span>. The <span class='tooltip-trigger'>trend<span class='tooltip-content'>trend = æµè¡Œ</span></span> didn't last long.",
            translation: "ã‚ã‚“ãªã«äººæ°—ã ã£ãŸã‚¿ãƒ”ã‚ªã‚«å±‹ã•ã‚“ãŒæ½°ã‚Œã¡ã‚ƒã£ãŸã€‚ãƒ–ãƒ¼ãƒ ã¯é•·ãç¶šã‹ãªã‹ã£ãŸã­ã€‚"
        },
        flashcards: [
            { en: "go bankrupt", ja: "å€’ç”£ã™ã‚‹", kana: "ã‚´ãƒ¼ãƒ»**ãƒ**ãƒ³ã‚¯ãƒ©ãƒ—ãƒˆ", phonetic: "/É¡oÊŠ ËˆbÃ¦Å‹krÊŒpt/", hint: "g" },
            { en: "myth", ja: "ç¥è©±", kana: "**ãƒŸ**ã‚¹", phonetic: "/mÉªÎ¸/", hint: "m" },
            { en: "financial", ja: "é‡‘èã®", kana: "ãƒ•ã‚¡ã‚¤**ãƒŠ**ãƒ³ã‚·ãƒ£ãƒ«", phonetic: "/faÉªËˆnÃ¦nÊƒl/", hint: "f" },
            { en: "institution", ja: "æ©Ÿé–¢", kana: "ã‚¤ãƒ³ã‚¹ãƒ†ã‚£**ãƒ†ãƒ¥ãƒ¼**ã‚·ãƒ§ãƒ³", phonetic: "/ËŒÉªnstÉªËˆtuËÊƒn/", hint: "i" }
        ]
    },
    {
        id: 32,
        originalSentence: "The reality of the situation is somewhat different from what he described.",
        translation: "ãã®çŠ¶æ³ã®ç¾å®Ÿã¯ã€å½¼ãŒèª¬æ˜ã—ãŸã‚‚ã®ã¨ã¯å¤šå°‘ç•°ãªã£ã¦ã„ã‚‹ã€‚",
        quiz: { target: "reality", choices: ["reality", "myth", "trial", "structure"], meaning: "ç¾å®Ÿ" },
        application: {
            situation: "ğŸ’¡ ã“ã‚“ãªå ´é¢ã§ä½¿ãˆã‚‹ï¼<br>SNSã§è¦‹ã‚‹ã‚­ãƒ©ã‚­ãƒ©ã—ãŸã‚¤ãƒ³ãƒ•ãƒ«ã‚¨ãƒ³ã‚µãƒ¼ã®ç”Ÿæ´»ã€‚ã§ã‚‚å®Ÿéš›ã¯â€¦ï¼Ÿ",
            sentence: "His life on <span class='tooltip-trigger'>social media<span class='tooltip-content'>SNSã®ã“ã¨ã€‚ãŸã ã—SNSã¯å’Œè£½è‹±èªã§ã€ãƒã‚¤ãƒ†ã‚£ãƒ–ã«ã¯é€šã˜ã¾ã›ã‚“ã€‚</span></span> looks perfect, but the <span class='tooltip-trigger'>reality<span class='tooltip-content'>ç¾å®Ÿ</span></span> is probably somewhat different.",
            translation: "SNSã§ã®å½¼ã®ç”Ÿæ´»ã¯å®Œç’§ã«è¦‹ãˆã‚‹ã‘ã©ã€ç¾å®Ÿã¯ãŸã¶ã‚“å¤šå°‘é•ã†ã‚“ã ã‚ã†ãªã€‚"
        },
        flashcards: [
            { en: "reality", ja: "ç¾å®Ÿ", kana: "ãƒª**ã‚¢**ãƒªãƒ†ã‚£", phonetic: "/riËˆÃ¦lÉ™ti/", hint: "r" },
            { en: "somewhat", ja: "å¤šå°‘", kana: "**ã‚µ**ãƒ ãƒ¯ãƒƒãƒˆ", phonetic: "/ËˆsÊŒmwÊŒt/", hint: "s" },
            { en: "be different from", ja: "ï½ã¨ç•°ãªã‚‹", kana: "ãƒ“ãƒ¼ãƒ»**ãƒ‡ã‚£**ãƒ•ã‚¡ãƒ¬ãƒ³ãƒˆãƒ»ãƒ•ãƒ­ãƒ ", phonetic: "/bi ËˆdÉªfrÉ™nt frÉ™m/", hint: "b" },
            { en: "media", ja: "ãƒã‚¹ãƒ¡ãƒ‡ã‚£ã‚¢", kana: "**ãƒŸãƒ¼**ãƒ‡ã‚£ã‚¢", phonetic: "/ËˆmiËdiÉ™/", hint: "m" },
            { en: "describe", ja: "ï½ã‚’æå†™ã™ã‚‹", kana: "ãƒ‡ã‚£ã‚¹**ã‚¯**ãƒ©ã‚¤ãƒ–", phonetic: "/dÉªËˆskraÉªb/", hint: "d" }
        ]
    },
    {
        id: 33,
        originalSentence: "In a friendship, what truly counts is not always visible to others.",
        translation: "å‹æƒ…ã«ãŠã„ã¦ã€æœ¬å½“ã«é‡è¦ãªã“ã¨ã¯ã€å¿…ãšã—ã‚‚ä»–äººã«è¦‹ãˆã‚‹ã‚ã‘ã§ã¯ãªã„ã€‚",
        quiz: { target: "counts", choices: ["counts", "describes", "fails", "grows"], meaning: "é‡è¦ã§ã‚ã‚‹" },
        application: {
            situation: "ğŸ’¡ ã“ã‚“ãªå ´é¢ã§ä½¿ãˆã‚‹ï¼<br>ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆé¸ã³ã€‚å€¤æ®µã®é«˜ã•ã‚ˆã‚Šã‚‚ã€ç›¸æ‰‹ã‚’æ€ã†æ°—æŒã¡ãŒå¤§åˆ‡ã€‚",
            sentence: "It's not the price of the gift that <span class='tooltip-trigger'>counts<span class='tooltip-content'>é‡è¦ã§ã‚ã‚‹</span></span>, it's the <span class='tooltip-trigger'>thought<span class='tooltip-content'>thought = æ€ã„ã€è€ƒãˆ</span></span> behind it.",
            translation: "é‡è¦ãªã®ã¯ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã®å€¤æ®µã˜ã‚ƒãªãã¦ã€ãã®è£ã«ã‚ã‚‹æ€ã„ã‚„ã‚Šã ã‚ˆã€‚"
        },
        flashcards: [
            { en: "count", ja: "é‡è¦ã§ã‚ã‚‹", kana: "**ã‚«**ã‚¦ãƒ³ãƒˆ", phonetic: "/kaÊŠnt/", hint: "c" },
            { en: "not always", ja: "ã„ã¤ã‚‚ï½ã¨ã¯é™ã‚‰ãªã„", kana: "ãƒãƒƒãƒˆãƒ»**ã‚ªãƒ¼**ãƒ«ã‚¦ã‚§ã‚¤ã‚º", phonetic: "/nÉ‘Ët ËˆÉ”ËlweÉªz/", hint: "n" },
            { en: "visible", ja: "ç›®ã«è¦‹ãˆã‚‹", kana: "**ãƒ´ã‚£**ã‚¸ãƒ–ãƒ«", phonetic: "/ËˆvÉªzÉ™bl/", hint: "v" }
        ]
    },
    {
        id: 34,
        originalSentence: "I can't make up my mind what to do with all this old stuff.",
        translation: "ã“ã®å¤ã„ã‚¬ãƒ©ã‚¯ã‚¿ã‚’ã©ã†ã—ãŸã‚‰ã‚ˆã„ã‹ã€æ±ºå¿ƒãŒã¤ã‹ãªã„ã€‚",
        quiz: { target: "make up my mind", choices: ["make up my mind", "take my time", "lose my temper", "change my mind"], meaning: "æ±ºå¿ƒã™ã‚‹" },
        application: {
            situation: "ğŸ’¡ ã“ã‚“ãªå ´é¢ã§ä½¿ãˆã‚‹ï¼<br>å¤§å­¦ã®å°‚æ”»ã‚’æ±ºã‚ã‚‹ã®ã«ã€ãªã‹ãªã‹æ±ºã‚ã‚‰ã‚Œãªã„å‹é”ã«ã€‚",
            sentence: "The <span class='tooltip-trigger'>application<span class='tooltip-content'>application = å‡ºé¡˜ã€ç”³è¾¼</span></span> deadline is next week. Have you <span class='tooltip-trigger'>made up your mind<span class='tooltip-content'>æ±ºå¿ƒã—ãŸ</span></span> about which university to <span class='tooltip-trigger'>apply to<span class='tooltip-content'>apply to = ï½ã«å‡ºé¡˜ã™ã‚‹</span></span>?",
            translation: "å‡ºé¡˜ã®ç· ã‚åˆ‡ã‚Šã¯æ¥é€±ã ã‚ˆã€‚ã©ã®å¤§å­¦ã«å‡ºé¡˜ã™ã‚‹ã‹ã‚‚ã†æ±ºã‚ãŸï¼Ÿ"
        },
        flashcards: [
            { en: "make up one's mind", ja: "æ±ºå¿ƒã™ã‚‹", kana: "ãƒ¡ã‚¤ã‚¯ãƒ»ã‚¢ãƒƒãƒ—ãƒ»ãƒ¯ãƒ³ã‚ºãƒ»**ãƒ**ã‚¤ãƒ³ãƒ‰", phonetic: "/meÉªk ÊŒp wÊŒnz maÉªnd/", hint: "m" },
            { en: "what to do", ja: "ä½•ã‚’ã™ã¹ãã‹", kana: "ãƒ¯ãƒƒãƒˆãƒ»ãƒˆã‚¥ãƒ»**ãƒ‰ã‚¥**", phonetic: "/wÊŒt tu du/", hint: "w" },
            { en: "the rest of", ja: "ï½ã®æ®‹ã‚Š", kana: "ã‚¶ãƒ»**ãƒ¬**ã‚¹ãƒˆãƒ»ã‚ªãƒ–", phonetic: "/Ã°É™ rest É™v/", hint: "t" },
            { en: "stuff", ja: "ç‰©ï¼ˆæ¼ ç„¶ã¨ï¼‰", kana: "ã‚¹**ã‚¿**ãƒƒãƒ•", phonetic: "/stÊŒf/", hint: "s" }
        ]
    },
    {
        id: 35,
        originalSentence: "He picked a card at random from the deck.",
        translation: "å½¼ã¯ãƒ‡ãƒƒã‚­ã‹ã‚‰ç„¡ä½œç‚ºã«ã‚«ãƒ¼ãƒ‰ã‚’1æšé¸ã‚“ã ã€‚",
        quiz: { target: "at random", choices: ["at random", "on foot", "in advance", "by accident"], meaning: "ç„¡ä½œç‚ºã«" },
        application: {
            situation: "ğŸ’¡ ã“ã‚“ãªå ´é¢ã§ä½¿ãˆã‚‹ï¼<br>éŸ³æ¥½ã®ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã‚’ä½œã‚‹æ™‚ã€ã¨ã‚Šã‚ãˆãšå¥½ããªæ›²ã‚’ã©ã‚“ã©ã‚“è¿½åŠ ã—ã¦ã„ãæ„Ÿã˜ã€‚",
            sentence: "I just added <span class='tooltip-trigger'>a bunch of<span class='tooltip-content'>a bunch of = ãŸãã•ã‚“ã®ï½</span></span> songs to the playlist <span class='tooltip-trigger'>at random<span class='tooltip-content'>ç„¡ä½œç‚ºã«</span></span>. We can <span class='tooltip-trigger'>organize<span class='tooltip-content'>organize = æ•´ç†ã™ã‚‹</span></span> it later.",
            translation: "ã¨ã‚Šã‚ãˆãšç„¡ä½œç‚ºã«ãŸãã•ã‚“ã®æ›²ã‚’ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ãŸã‚“ã ã€‚æ•´ç†ã¯å¾Œã§ã§ãã‚‹ã‹ã‚‰ã­ã€‚"
        },
        flashcards: [
            { en: "at random", ja: "ç„¡ä½œç‚ºã«", kana: "ã‚¢ãƒƒãƒˆãƒ»**ãƒ©**ãƒ³ãƒ€ãƒ ", phonetic: "/Ã¦t ËˆrÃ¦ndÉ™m/", hint: "a" },
            { en: "pick", ja: "ï½ã‚’é¸ã¶", kana: "**ãƒ”**ãƒƒã‚¯", phonetic: "/pÉªk/", hint: "p" },
            { en: "in order", ja: "é †ç•ªã«", kana: "ã‚¤ãƒ³ãƒ»**ã‚ªãƒ¼**ãƒ€ãƒ¼", phonetic: "/Éªn ËˆÉ”ËrdÉ™r/", hint: "i" },
            { en: "correct", ja: "æ­£ã—ã„", kana: "ã‚³**ãƒ¬**ã‚¯ãƒˆ", phonetic: "/kÉ™Ëˆrekt/", hint: "c" }
        ]
    },
    {
        id: 36,
        originalSentence: "The movie studio will release his biography next year.",
        translation: "ãã®æ˜ ç”»ã‚¹ã‚¿ã‚¸ã‚ªã¯æ¥å¹´ã€å½¼ã®ä¼è¨˜ã‚’å…¬é–‹ã™ã‚‹äºˆå®šã ã€‚",
        quiz: { target: "release", choices: ["release", "describe", "deceive", "predict"], meaning: "ï½ã‚’ç™ºå£²ã™ã‚‹" },
        application: {
            situation: "ğŸ’¡ ã“ã‚“ãªå ´é¢ã§ä½¿ãˆã‚‹ï¼<br>å¤§å¥½ããªã‚²ãƒ¼ãƒ ã‚·ãƒªãƒ¼ã‚ºã®æœ€æ–°ä½œãŒç™ºå£²ã•ã‚Œã‚‹æ—¥ã€‚",
            sentence: "The new game will be <span class='tooltip-trigger'>released<span class='tooltip-content'>ç™ºå£²ã•ã‚Œã‚‹</span></span> at <span class='tooltip-trigger'>midnight<span class='tooltip-content'>midnight = æ·±å¤œ0æ™‚</span></span>. I'm going to <span class='tooltip-trigger'>stay up all night<span class='tooltip-content'>stay up all night = å¾¹å¤œã™ã‚‹</span></span> playing it!",
            translation: "æ–°ã—ã„ã‚²ãƒ¼ãƒ ã¯æ·±å¤œ0æ™‚ã«ç™ºå£²ã ã€‚å¾¹å¤œã§ãƒ—ãƒ¬ã‚¤ã™ã‚‹ãï¼"
        },
        flashcards: [
            { en: "release", ja: "ï½ã‚’ç™ºå£²ã™ã‚‹", kana: "ãƒª**ãƒªãƒ¼**ã‚¹", phonetic: "/rÉªËˆliËs/", hint: "r" },
            { en: "biography", ja: "ä¼è¨˜", kana: "ãƒã‚¤**ã‚ª**ã‚°ãƒ©ãƒ•ã‚£", phonetic: "/baÉªËˆÉ‘ËÉ¡rÉ™fi/", hint: "b" },
            { en: "stand in line", ja: "ä¸€åˆ—ã«ä¸¦ã¶", kana: "ã‚¹**ã‚¿**ãƒ³ãƒ‰ãƒ»ã‚¤ãƒ³ãƒ»**ãƒ©**ã‚¤ãƒ³", phonetic: "/stÃ¦nd Éªn laÉªn/", hint: "s" },
            { en: "get", ja: "ï½ã‚’æ‰‹ã«å…¥ã‚Œã‚‹", kana: "**ã‚²**ãƒƒãƒˆ", phonetic: "/É¡et/", hint: "g" }
        ]
    },
    {
        id: 37,
        originalSentence: "I'm anxious about the exam results and I miss my family.",
        translation: "è©¦é¨“ã®çµæœãŒå¿ƒé…ã§ã€å®¶æ—ã«ä¼šãˆãªãã¦å¯‚ã—ã„ã€‚",
        quiz: { target: "anxious", choices: ["anxious", "solid", "vague", "rare"], meaning: "å¿ƒé…ã—ã¦" },
        application: {
            situation: "ğŸ’¡ ã“ã‚“ãªå ´é¢ã§ä½¿ãˆã‚‹ï¼<br>å¥½ããªäººã«LINEã‚’é€ã£ãŸã‘ã©ã€æ—¢èª­ã®ã¾ã¾â€¦ã€‚è¿”ä¿¡ãŒå¾…ã¡é ã—ã„ï¼",
            sentence: "I'm so anxious to <span class='tooltip-trigger'>hear from<span class='tooltip-content'>hear from... = ï½ã‹ã‚‰é€£çµ¡ã‚’ã‚‚ã‚‰ã†<br>hear of... (ï½ã®ã“ã¨ã‚’è€³ã«ã™ã‚‹) ã¨ã®é•ã„ã«æ³¨æ„ï¼</span></span> them. I keep checking my phone every five minutes!",
            translation: "å½¼/å½¼å¥³ã‹ã‚‰é€£çµ¡ãŒæ¥ã‚‹ã®ã‚’å¿ƒå¾…ã¡ã«ã—ã¦ã„ã‚‹ã‚ˆã€‚5åˆ†ãŠãã«ã‚¹ãƒãƒ›ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¡ã‚ƒã†ï¼"
        },
        flashcards: [
            { en: "anxious", ja: "å¿ƒé…ã—ã¦", kana: "**ã‚¢**ãƒ³ã‚¯ã‚·ãƒ£ã‚¹", phonetic: "/ËˆÃ¦Å‹kÊƒÉ™s/", hint: "a" },
            { en: "hear from", ja: "ï½ã‹ã‚‰é€£çµ¡ã‚’ã‚‚ã‚‰ã†", kana: "**ãƒ’ãƒ¼**ãƒ»ãƒ•ãƒ­ãƒ ", phonetic: "/hÉªr frÉ™m/", hint: "h" },
            { en: "miss", ja: "ï½ãŒã„ãªãã¦å¯‚ã—ãæ€ã†", kana: "**ãƒŸ**ã‚¹", phonetic: "/mÉªs/", hint: "m" }
        ]
    },
    {
        id: 38,
        originalSentence: "By the way, my father used to run a small grocery store.",
        translation: "ã¨ã“ã‚ã§ã€ç§ã®çˆ¶ã¯ä»¥å‰ã€å°ã•ãªé£Ÿæ–™å“åº—ã‚’çµŒå–¶ã—ã¦ã„ã¾ã—ãŸã€‚",
        quiz: { target: "By the way", choices: ["By the way", "On the way", "In a way", "For a change"], meaning: "ã¨ã“ã‚ã§" },
        application: {
            situation: "ğŸ’¡ ã“ã‚“ãªå ´é¢ã§ä½¿ãˆã‚‹ï¼<br>åˆã‚ã¦ä¼šã£ãŸäººã¨è©±ã—ã¦ã„ã¦ã€å°‘ã—è©±é¡Œã‚’å¤‰ãˆãŸã„æ™‚ã€‚",
            sentence: "That's interesting. <span class='tooltip-trigger'>By the way<span class='tooltip-content'>ã¨ã“ã‚ã§</span></span>, are you <span class='tooltip-trigger'>from around here<span class='tooltip-content'>from around here = ã“ã®è¾ºã‚Šã®å‡ºèº«</span></span>?",
            translation: "é¢ç™½ã„ã§ã™ã­ã€‚ã¨ã“ã‚ã§ã€ã“ã®è¾ºã‚Šã®ã”å‡ºèº«ã§ã™ã‹ï¼Ÿ"
        },
        flashcards: [
            { en: "By the way", ja: "ã¨ã“ã‚ã§", kana: "ãƒã‚¤ãƒ»ã‚¶ãƒ»**ã‚¦ã‚§**ã‚¤", phonetic: "/baÉª Ã°É™ weÉª/", hint: "B" },
            { en: "What do you do?", ja: "ãŠä»•äº‹ã¯ä½•ã§ã™ã‹ï¼Ÿ", kana: "ãƒ¯ãƒƒãƒˆãƒ»ãƒ‰ã‚¥ãƒ»ãƒ¦ãƒ¼ãƒ»**ãƒ‰ã‚¥**ï¼Ÿ", phonetic: "/wÊŒt du ju du/", hint: "W" },
            { en: "run", ja: "ï½ã‚’çµŒå–¶ã™ã‚‹", kana: "**ãƒ©**ãƒ³", phonetic: "/rÊŒn/", hint: "r" },
            { en: "grocery store", ja: "é£Ÿæ–™å“åº—", kana: "ã‚°**ãƒ­**ã‚µãƒªãƒ¼ãƒ»ã‚¹ãƒˆã‚¢", phonetic: "/ËˆÉ¡roÊŠsÉ™ri stÉ”Ër/", hint: "g" }
        ]
    },
    {
        id: 39,
        originalSentence: "He leaned close to whisper a secret in her ear.",
        translation: "å½¼ã¯å½¼å¥³ã®è€³ã«ç§˜å¯†ã‚’ã•ã•ã‚„ããŸã‚ã«ã€ãã£ã¨èº«ã‚’å¯„ã›ãŸã€‚",
        quiz: { target: "whisper", choices: ["whisper", "nod", "argue", "shout"], meaning: "ã•ã•ã‚„ã" },
        application: {
            situation: "ğŸ’¡ ã“ã‚“ãªå ´é¢ã§ä½¿ãˆã‚‹ï¼<br>æˆæ¥­ä¸­ã€å…ˆç”Ÿã«èã“ãˆãªã„ã‚ˆã†ã«éš£ã®å¸­ã®å‹é”ã«ä½•ã‹ã‚’ä¼ãˆã‚‹ã€‚",
            sentence: "She <span class='tooltip-trigger'>leaned over<span class='tooltip-content'>lean over = èº«ã‚’ä¹—ã‚Šå‡ºã™</span></span> and <span class='tooltip-trigger'>whispered<span class='tooltip-content'>ã•ã•ã‚„ã„ãŸ</span></span> something to me.",
            translation: "å½¼å¥³ã¯èº«ã‚’ä¹—ã‚Šå‡ºã—ã¦ã€ç§ã«ä½•ã‹ã‚’ã•ã•ã‚„ã„ãŸã€‚"
        },
        flashcards: [
            { en: "whisper", ja: "ã•ã•ã‚„ã", kana: "**ã‚¦ã‚£**ã‚¹ãƒ‘ãƒ¼", phonetic: "/ËˆwÉªspÉ™r/", hint: "w" },
            { en: "lean", ja: "å‚¾ãã€å¯„ã‚Šã‹ã‹ã‚‹", kana: "**ãƒªãƒ¼**ãƒ³", phonetic: "/liËn/", hint: "l" },
            { en: "come with", ja: "ï½ã¨ä¸€ç·’ã«è¡Œã", kana: "**ã‚«**ãƒ ãƒ»ã‚¦ã‚£ã‚º", phonetic: "/kÊŒm wÉªÃ°/", hint: "c" }
        ]
    },
    {
        id: 40,
        originalSentence: "I can't stand his selfish attitude anymore.",
        translation: "å½¼ã®ã‚ãŒã¾ã¾ãªæ…‹åº¦ã«ã¯ã‚‚ã†æˆ‘æ…¢ã§ããªã„ã€‚",
        quiz: { target: "stand", choices: ["stand", "run", "sit", "lie"], meaning: "ï½ã‚’æˆ‘æ…¢ã™ã‚‹" },
        application: {
            situation: "ğŸ’¡ ã“ã‚“ãªå ´é¢ã§ä½¿ãˆã‚‹ï¼<br>ãƒ«ãƒ¼ãƒ ãƒ¡ã‚¤ãƒˆãŒéƒ¨å±‹ã‚’å…¨ãç‰‡ä»˜ã‘ãªã„ã€‚ã¤ã„ã«å ªå¿è¢‹ã®ç·’ãŒåˆ‡ã‚ŒãŸï¼",
            sentence: "I can't <span class='tooltip-trigger'>stand<span class='tooltip-content'>æˆ‘æ…¢ã™ã‚‹</span></span> your <span class='tooltip-trigger'>clutter<span class='tooltip-content'>clutter = æ•£ã‚‰ã‹ã£ãŸã‚‚ã®</span></span> anymore! You need to clean your side of the room.",
            translation: "ã‚ãªãŸã®æ•£ã‚‰ã‹ã—ã£ã·ã‚Šã«ã¯ã‚‚ã†æˆ‘æ…¢ã§ããªã„ï¼éƒ¨å±‹ã®è‡ªåˆ†ã®å´ã‚’æƒé™¤ã—ã¦ã‚ˆã€‚"
        },
        flashcards: [
            { en: "stand", ja: "ï½ã‚’æˆ‘æ…¢ã™ã‚‹", kana: "ã‚¹**ã‚¿**ãƒ³ãƒ‰", phonetic: "/stÃ¦nd/", hint: "s" },
            { en: "mess", ja: "ã‚ã¡ã‚ƒãã¡ã‚ƒãªçŠ¶æ…‹", kana: "**ãƒ¡**ã‚¹", phonetic: "/mes/", hint: "m" },
            { en: "not ... anymore", ja: "ã‚‚ã¯ã‚„ï½ãªã„", kana: "ãƒãƒƒãƒˆãƒ»ã‚¨ãƒ‹ãƒ¼**ãƒ¢ãƒ¼**", phonetic: "/nÉ‘Ët ËŒeniËˆmÉ”Ër/", hint: "n" }
        ]
    }
];

// --- STATE ---
let currentSentenceIndex = 0;
let currentStep = 1;
let selfAssessments = new Array(quizData.length).fill(null);
let quizResults = new Array(quizData.length).fill(null);
let isSequentialMode = false; 
let speechSynthesis = window.speechSynthesis;
let maleVoices = [];
let femaleVoices = [];
let voiceToggle = 0;
let quizQueue = [];

// --- DOM ELEMENTS ---
const tocScreen = document.getElementById('toc-screen');
const mainQuizArea = document.getElementById('main-quiz-area');
const finalCheckArea = document.getElementById('final-check-area');
const resultScreen = document.getElementById('result-screen');
const startSequentialBtn = document.getElementById('start-sequential-btn');
const finalCheckBtn = document.getElementById('final-check-btn');
const nextBtn = document.getElementById('next-btn');
const reviewBtn = document.getElementById('review-btn');
const backToTocBtn = document.getElementById('back-to-toc-btn');
const backToTocFromFinalBtn = document.getElementById('back-to-toc-from-final-btn');

const stepViews = {
    1: document.getElementById('step1-quiz'),
    2: document.getElementById('step2-application'),
    3: document.getElementById('step3-flashcards'),
};
const stepIndicators = {
    1: document.getElementById('step-indicator-1'),
    2: document.getElementById('step-indicator-2'),
    3: document.getElementById('step-indicator-3'),
};

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', showMainMenu);

// --- EVENT LISTENERS ---
startSequentialBtn.addEventListener('click', () => {
    isSequentialMode = true;
    quizResults = new Array(quizData.length).fill(null);
    selfAssessments = new Array(quizData.length).fill(null);
    startQuizSession(Array.from(Array(quizData.length).keys()));
});

finalCheckBtn.addEventListener('click', () => {
    isSequentialMode = false;
    renderFinalCheck();
});

nextBtn.addEventListener('click', handleNext);
reviewBtn.addEventListener('click', showMainMenu);
backToTocBtn.addEventListener('click', showMainMenu);
backToTocFromFinalBtn.addEventListener('click', showMainMenu);

// --- Voice Initialization Logic (Alternating Male/Female) ---
const MALE_VOICE_KEYWORDS = ["Alex", "Daniel", "Fred", "Tom", "Google US English", "Microsoft David", "Male"];
const FEMALE_VOICE_KEYWORDS = ["Samantha", "Allison", "Ava", "Martha", "Susan", "Aria", "Google UK English Female", "Microsoft Zira", "Female"];

async function voicesReady(timeoutMs = 2500) {
  return new Promise((resolve) => {
    const start = performance.now();
    const pump = () => {
      const v = speechSynthesis.getVoices();
      if (v && v.length) return resolve(v);
      if (performance.now() - start > timeoutMs) return resolve(v);
      if (!speechSynthesis.speaking) {
        const u = new SpeechSynthesisUtterance(" ");
        u.volume = 0;
        speechSynthesis.speak(u);
      }
      requestAnimationFrame(pump);
    };
    pump();
  });
}

async function initVoice() {
    let voices = await voicesReady();
    if (!voices || !voices.length) voices = speechSynthesis.getVoices();

    const englishVoices = voices.filter(v => /^en(-|_)/i.test(v.lang));
    
    let tempFemaleVoices = englishVoices.filter(v => FEMALE_VOICE_KEYWORDS.some(keyword => v.name.includes(keyword)));
    const femaleNames = new Set(tempFemaleVoices.map(v => v.name));

    let tempMaleVoices = englishVoices.filter(v => MALE_VOICE_KEYWORDS.some(keyword => v.name.includes(keyword)) && !femaleNames.has(v.name));
    const maleNames = new Set(tempMaleVoices.map(v => v.name));
    
    const remainingVoices = englishVoices.filter(v => !femaleNames.has(v.name) && !maleNames.has(v.name));
    
    femaleVoices = tempFemaleVoices;
    maleVoices = tempMaleVoices;

    if (femaleVoices.length > 0 && maleVoices.length === 0 && remainingVoices.length > 0) maleVoices = remainingVoices;
    if (maleVoices.length > 0 && femaleVoices.length === 0 && remainingVoices.length > 0) femaleVoices = remainingVoices;
    
    if (maleVoices.length === 0 && femaleVoices.length > 0) maleVoices = femaleVoices;
    if (femaleVoices.length === 0 && maleVoices.length > 0) femaleVoices = maleVoices;

    if (maleVoices.length === 0 && femaleVoices.length === 0 && englishVoices.length > 0) {
         console.warn("Could not classify voices into male/female. Using any available English voices for both.");
         maleVoices = englishVoices;
         femaleVoices = englishVoices;
    }
    
    console.log("--- Voice Diagnosis ---");
    console.log("All available English voices:", englishVoices.map(v => v.name));
    console.log("Assigned Male voices:", maleVoices.map(v => v.name));
    console.log("Assigned Female voices:", femaleVoices.map(v => v.name));
    console.log("-----------------------");
}

speechSynthesis.onvoiceschanged = () => { initVoice(); };
initVoice();

// --- FUNCTIONS ---

function speak(text, lang = 'en-US') {
    try {
        if (speechSynthesis.speaking) speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = lang || 'en-US';

        let selectedVoice = null;
        const turnIndex = Math.floor(voiceToggle / 2);

        if (voiceToggle % 2 === 0 && maleVoices.length > 0) {
            selectedVoice = maleVoices[turnIndex % maleVoices.length];
        } else if (femaleVoices.length > 0) {
            selectedVoice = femaleVoices[turnIndex % femaleVoices.length];
        } else if (maleVoices.length > 0) {
            selectedVoice = maleVoices[turnIndex % maleVoices.length];
        }

        if (selectedVoice) {
            u.voice = selectedVoice;
            console.log(`Speaking with voice: ${selectedVoice.name}`);
        } else {
            console.warn("A specific voice could not be selected. Using browser default.");
        }
        
        voiceToggle++;

        u.rate = 0.9;
        u.pitch = 1.0;
        speechSynthesis.speak(u);
    } catch (e) {
        console.error('TTS error:', e);
    }
}

function showMainMenu() {
    resultScreen.classList.add('hidden');
    mainQuizArea.classList.add('hidden');
    finalCheckArea.classList.add('hidden');
    tocScreen.classList.remove('hidden');
    
    const tocList = document.getElementById('toc-list');
    tocList.innerHTML = '';
    quizData.forEach((data, index) => {
        const quizNeedsReview = quizResults[index] === false;
        const appNeedsReview = selfAssessments[index] === false;

        const item = document.createElement('button');
        item.className = 'toc-item p-3 border rounded-lg text-center hover:bg-gray-100 transition-colors flex flex-col justify-center items-center h-full';
        if (quizNeedsReview || appNeedsReview) item.classList.add('needs-review', 'border-red-400', 'bg-red-50');
        
        let reviewMarksHTML = '<div class="flex items-center mt-1">';
        if (quizNeedsReview) {
            reviewMarksHTML += '<span class="review-mark" title="ã‚¯ã‚¤ã‚ºã‚’å¾©ç¿’">Q</span>';
        }
        if (appNeedsReview) {
            reviewMarksHTML += '<span class="review-mark" title="å¿œç”¨ã‚’å¾©ç¿’">A</span>';
        }
        reviewMarksHTML += '</div>';

        item.innerHTML = `
            <div class="toc-item-content">
                <span class="font-semibold">ä¾‹æ–‡ ${data.id}</span>
                ${(quizNeedsReview || appNeedsReview) ? reviewMarksHTML : ''}
            </div>
        `;
        item.onclick = () => {
            isSequentialMode = false;
            startQuizSession([index]);
        };
        tocList.appendChild(item);
    });
}


function startQuizSession(indices) {
    quizQueue = indices.map(i => ({ index: i, originalIndex: i })); 
    if (quizQueue.length === 0) {
        showMainMenu();
        return;
    }
    const session = quizQueue.shift();
    currentSentenceIndex = session.originalIndex;
    
    currentStep = 1;
    tocScreen.classList.add('hidden');
    resultScreen.classList.add('hidden');
    mainQuizArea.classList.remove('hidden');
    nextBtn.classList.add('hidden');
    renderCurrentStep();
}

function handleNext() {
    currentStep++;

    if (currentStep > 3) { // After flashcards
        if (quizQueue.length > 0) { // More questions in queue
            const session = quizQueue.shift();
            currentSentenceIndex = session.originalIndex;
            currentStep = 1;
            renderCurrentStep();
        } else { // No more questions
            if (isSequentialMode) {
                 showResult();
            } else {
                showMainMenu();
            }
        }
    } else {
        renderCurrentStep();
    }
}


function updateProgress() {
    const currentData = quizData[currentSentenceIndex];
    if (!currentData) return; 

    document.getElementById('question-counter').textContent = `ä¾‹æ–‡ ${currentData.id}`;
    
    if (isSequentialMode) {
        const totalQuestions = quizData.length;
        const completedQuestions = totalQuestions - quizQueue.length - 1;
        const progress = (completedQuestions / totalQuestions) * 100;
        document.getElementById('progress-bar').style.width = `${progress}%`;
        document.getElementById('progress-bar').classList.remove('hidden');

    } else {
        document.getElementById('progress-bar').classList.add('hidden');
    }


    Object.values(stepIndicators).forEach(el => el.classList.remove('active'));
    if (stepIndicators[currentStep]) {
        stepIndicators[currentStep].classList.add('active');
    }
}

function renderCurrentStep() {
    updateProgress();
    Object.values(stepViews).forEach(view => view.classList.add('hidden'));
    stepViews[currentStep].classList.remove('hidden');
    nextBtn.classList.add('hidden');

    const data = quizData[currentSentenceIndex];
    switch (currentStep) {
        case 1: renderStep1(data); break;
        case 2: renderStep2(data); break;
        case 3: renderStep3(data); break;
    }
}

// --- RENDER FUNCTIONS FOR EACH STEP ---

function renderStep1(data) {
    const { quiz, originalSentence } = data;
    const questionText = originalSentence.replace(new RegExp(quiz.target.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1"), 'i'), '______');
    const shuffledChoices = [...quiz.choices].sort(() => Math.random() - 0.5);
    
    let optionsHTML = shuffledChoices.map(choice => 
        `<button class="btn-option w-full p-4 bg-white border border-gray-300 rounded-lg text-left text-gray-700 font-medium transition-all duration-200">${choice}</button>`
    ).join('');

    stepViews[1].innerHTML = `
        <p class="text-sm text-gray-500 text-center mb-4">ã‚ã¦ã¯ã¾ã‚‹é¸æŠè‚¢ã‚’é¸ã³ã¾ã—ã‚‡ã†ã€‚</p>
        <div class="mb-6 relative">
            <p class="text-xl md:text-2xl text-gray-800 text-center p-4 bg-gray-50 rounded-lg">${questionText}</p>
            <button class="speaker-btn text-xl" onclick="speak('${originalSentence.replace(/'/g, "\\'")}')"><i class="fas fa-volume-up"></i></button>
        </div>
        <div id="step1-options" class="grid grid-cols-1 md:grid-cols-2 gap-4">${optionsHTML}</div>
        <div id="step1-feedback" class="p-4 rounded-lg text-center font-medium hidden my-4"></div>
    `;

    document.getElementById('step1-options').addEventListener('click', e => {
        if (e.target.tagName === 'BUTTON') {
            handleQuizAnswer(e.target, quiz, data.translation);
        }
    });
}

function handleQuizAnswer(selectedButton, quizInfo, translation) {
    const isCorrect = selectedButton.innerText.toLowerCase() === quizInfo.target.toLowerCase();
    
    quizResults[currentSentenceIndex] = isCorrect;
    
    const feedbackEl = document.getElementById('step1-feedback');
    
    if (isCorrect) {
        feedbackEl.innerHTML = `æ­£è§£ï¼ <span class="font-bold">${quizInfo.target}</span> ã¯ã€Œ${quizInfo.meaning}ã€ã¨ã„ã†æ„å‘³ã§ã™ã€‚`;
        feedbackEl.className = 'p-4 rounded-lg text-center font-medium my-4 bg-green-100 border border-green-300 text-green-800';
    } else {
        feedbackEl.innerHTML = `ä¸æ­£è§£ã€‚æ­£è§£ã¯ <span class="font-bold">${quizInfo.target}</span> ã§ã™ã€‚<br>ã€Œ${quizInfo.meaning}ã€ã¨ã„ã†æ„å‘³ã«ãªã‚Šã¾ã™ã€‚`;
        feedbackEl.className = 'p-4 rounded-lg text-center font-medium my-4 bg-red-100 border border-red-300 text-red-800';
    }
    feedbackEl.classList.remove('hidden');
    
    const translationEl = document.createElement('p');
    translationEl.className = 'text-center text-gray-600 mt-2';
    translationEl.textContent = `æ–‡å…¨ä½“ã®è¨³ï¼š${translation}`;
    feedbackEl.appendChild(translationEl);

    Array.from(document.getElementById('step1-options').children).forEach(button => {
        button.disabled = true;
        if (button.innerText.toLowerCase() === quizInfo.target.toLowerCase()) button.classList.add('bg-green-200', 'border-green-500');
        else if (button === selectedButton) button.classList.add('bg-red-200', 'border-red-500');
    });

    nextBtn.textContent = 'å¿œç”¨ä¾‹æ–‡ã¸ â†’';
    nextBtn.classList.remove('hidden');
}

function renderStep2(data) {
    const { application } = data;
    stepViews[2].innerHTML = `
        <p class="text-sm text-gray-500 text-center mb-4">å¿œç”¨ä¾‹æ–‡ã§ä½¿ã„æ–¹ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚</p>
        <div class="bg-sky-50 border-l-4 border-sky-500 p-4 rounded-lg mb-4">
            <p class="font-semibold text-sky-800 mb-2">${application.situation}</p>
        </div>
        <div class="mb-4 relative p-4 bg-gray-50 rounded-lg">
            <p class="text-lg md:text-xl text-gray-800">${application.sentence}</p>
            <button class="speaker-btn text-xl" onclick="speak(this.previousElementSibling.innerText.replace(/'/g, &quot;\\'&quot;))"><i class="fas fa-volume-up"></i></button>
        </div>
        <div class="text-center mb-6">
            <button id="show-translation-btn" class="text-blue-600 hover:underline">æ—¥æœ¬èªè¨³ã‚’è¦‹ã‚‹</button>
        </div>
        <p id="translation-text" class="text-center text-gray-600 hidden mb-6">${application.translation}</p>
        <div id="self-assessment-buttons" class="flex justify-center space-x-4">
            <button data-cleared="false" class="self-assess-btn border border-gray-400 text-gray-700 font-bold py-2 px-6 rounded-full hover:bg-gray-100">ã‚‚ã†ä¸€åº¦</button>
            <button data-cleared="true" class="self-assess-btn bg-green-500 text-white font-bold py-2 px-6 rounded-full hover:bg-green-600">ç†è§£ã§ããŸï¼</button>
        </div>
    `;

    document.getElementById('show-translation-btn').addEventListener('click', e => {
        document.getElementById('translation-text').classList.toggle('hidden');
        e.target.textContent = document.getElementById('translation-text').classList.contains('hidden') ? 'æ—¥æœ¬èªè¨³ã‚’è¦‹ã‚‹' : 'æ—¥æœ¬èªè¨³ã‚’éš ã™';
    });

    document.getElementById('self-assessment-buttons').addEventListener('click', e => {
        if (e.target.classList.contains('self-assess-btn')) {
            const cleared = e.target.dataset.cleared === 'true';
            selfAssessments[currentSentenceIndex] = cleared;
            
            nextBtn.textContent = 'å˜èªã®å¾©ç¿’ã¸ â†’';
            nextBtn.classList.remove('hidden');
            document.querySelectorAll('.self-assess-btn').forEach(btn => {
                btn.disabled = true;
                btn.classList.add('opacity-50');
            });
            e.target.classList.remove('opacity-50');
        }
    });
}

function renderFlashcards(container, cards, defaultMode) {
    container.innerHTML = '';
    cards.forEach(card => {
        const cardEl = document.createElement('div');
        cardEl.className = 'flashcard h-48';
        
        const frontContent = (defaultMode === 'en-ja') 
            ? `<h3 class="text-2xl font-bold">${card.en}</h3>`
            : `<h3 class="text-xl font-bold">${card.ja}</h3><p class="text-gray-500 mt-2">ãƒ’ãƒ³ãƒˆ: ${card.hint}</p>`;
        
        const backContent = (defaultMode === 'en-ja')
            ? `<h3 class="text-xl font-bold">${card.ja}</h3>`
            : `<h3 class="text-2xl font-bold">${card.en}</h3>`;

        cardEl.innerHTML = `
            <div class="flashcard-inner">
                <div class="flashcard-front">${frontContent}<button class="speaker-btn" onclick="event.stopPropagation(); speak('${card.en.replace(/'/g, "\\'")}')"><i class="fas fa-volume-up"></i></button></div>
                <div class="flashcard-back">
                    ${backContent}
                    <div class="text-center mt-2">
                        <p class="text-gray-500">${card.kana.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')}</p>
                        <p class="text-gray-400 text-sm">${card.phonetic}</p>
                    </div>
                    <button class="speaker-btn" onclick="event.stopPropagation(); speak('${card.en.replace(/'/g, "\\'")}')"><i class="fas fa-volume-up"></i></button>
                </div>
            </div>
        `;
        cardEl.addEventListener('click', () => cardEl.classList.toggle('flipped'));
        container.appendChild(cardEl);
    });
}

function renderStep3(data) {
    const { flashcards } = data;
    stepViews[3].innerHTML = `
        <p class="text-sm text-gray-500 text-center mb-4">ã‚«ãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é–¢é€£å˜èªã‚‚è¦šãˆã¾ã—ã‚‡ã†ã€‚</p>
        <div class="flex justify-center mb-4">
            <div class="inline-flex rounded-md shadow-sm" role="group">
                <button type="button" id="mode-en-ja-step3" class="mode-btn bg-blue-500 text-white px-4 py-2 text-sm font-medium border border-gray-200 rounded-l-lg">èªè­˜ (è‹±â†’æ—¥)</button>
                <button type="button" id="mode-ja-en-step3" class="mode-btn bg-white text-gray-900 px-4 py-2 text-sm font-medium border border-gray-200 rounded-r-lg hover:bg-gray-100">æƒ³èµ· (æ—¥â†’è‹±)</button>
            </div>
        </div>
        <div id="flashcard-container-step3" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    `;

    const container = document.getElementById('flashcard-container-step3');
    renderFlashcards(container, flashcards, 'en-ja');

    const modeBtnEnJa = document.getElementById('mode-en-ja-step3');
    const modeBtnJaEn = document.getElementById('mode-ja-en-step3');
    
    modeBtnEnJa.addEventListener('click', () => {
        modeBtnEnJa.classList.add('bg-blue-500', 'text-white');
        modeBtnJaEn.classList.remove('bg-blue-500', 'text-white');
        renderFlashcards(container, flashcards, 'en-ja');
    });
    
    modeBtnJaEn.addEventListener('click', () => {
        modeBtnJaEn.classList.add('bg-blue-500', 'text-white');
        modeBtnEnJa.classList.remove('bg-blue-500', 'text-white');
        renderFlashcards(container, flashcards, 'ja-en');
    });

    const nextText = quizQueue.length === 0 ? 
        (isSequentialMode ? 'çµæœã‚’è¦‹ã‚‹' : 'ç›®æ¬¡ã«æˆ»ã‚‹') : 
        'æ¬¡ã®å•é¡Œã¸ â†’';
    nextBtn.textContent = nextText;
    nextBtn.classList.remove('hidden');
}

function renderFinalCheck() {
    tocScreen.classList.add('hidden');
    mainQuizArea.classList.add('hidden');
    resultScreen.classList.add('hidden');
    finalCheckArea.classList.remove('hidden');

    let allHeadwords = quizData.flatMap(d => d.flashcards);
    allHeadwords.sort(() => Math.random() - 0.5);
    const container = document.getElementById('final-check-flashcards');
    renderFlashcards(container, allHeadwords, 'ja-en');
}

function showResult() {
    mainQuizArea.classList.add('hidden');
    resultScreen.classList.remove('hidden');
    
    const clearedCount = selfAssessments.filter(sa => sa === true).length;
    const totalAssessed = selfAssessments.filter(sa => sa !== null).length;
    
    const summaryEl = document.getElementById('self-assessment-summary');
    summaryEl.innerHTML = `
        <p class="text-xl">å¿œç”¨ä¾‹æ–‡ã®ç†è§£åº¦: <span class="font-bold text-green-600">${clearedCount}</span> / ${totalAssessed}</p>
        <p class="text-gray-600 mt-2">ã€Œã‚‚ã†ä¸€åº¦ã€ã‚’é¸ã‚“ã å•é¡Œã‚„ã‚¯ã‚¤ã‚ºã§é–“é•ãˆãŸå•é¡Œã¯ã€å¾©ç¿’ãƒªã‚¹ãƒˆã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
    `;
}

</script>
</body>
</html>